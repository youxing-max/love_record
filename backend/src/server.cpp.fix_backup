#include "server.h"
#include <iostream>
#include <sstream>
#include <string>
#include <vector>
#include <map>
#include <filesystem>
#include <fstream>
#include <chrono>
#include <ctime>
#include <thread>
#include <cstring>
#include <netinet/in.h>
#include <sys/socket.h>
#include <unistd.h>
#include <sys/stat.h>
#include <fcntl.h>

// å®Œæ•´çš„ServerImplç±»å®šä¹‰

// è·å–é¡¹ç›®æ ¹ç›®å½•
std::string getProjectRoot() {
    static std::string projectRoot;
    if (projectRoot.empty()) {
        char buffer[1024];
        ssize_t len = readlink("/proc/self/exe", buffer, sizeof(buffer) - 1);
        if (len != -1) {
            buffer[len] = '\0';
            std::string exePath(buffer);
            // å‡è®¾å¯æ‰§è¡Œæ–‡ä»¶åœ¨ backend/build/ ç›®å½•ä¸‹
            size_t pos = exePath.rfind("/backend/build/");
            if (pos != std::string::npos) {
                projectRoot = exePath.substr(0, pos);
            } else {
                // å›é€€æ–¹æ¡ˆï¼šä½¿ç”¨å½“å‰å·¥ä½œç›®å½•
                projectRoot = ".";
            }
        } else {
            projectRoot = ".";
        }
    }
    return projectRoot;
}

class Server::ServerImpl {
public:
    ServerImpl() : port(9998), running(false) {}
    int port;
    bool running;
};

// æ„é€ å‡½æ•°
Server::Server() : pImpl(std::make_unique<ServerImpl>()) {}

// ææ„å‡½æ•°
Server::~Server() {
    stop();
}

// åˆå§‹åŒ–æœåŠ¡å™¨
bool Server::initialize(int port, const std::string& dbPath) {
    pImpl->port = port;
    std::cout << "âœ… æœåŠ¡å™¨åˆå§‹åŒ–æˆåŠŸ!" << std::endl;
    return true;
}

// å¯åŠ¨æœåŠ¡å™¨
void Server::start() {
    pImpl->running = true;
    std::cout << "ğŸŒ¸ LoveRecord Server Starting..." << std::endl;
    std::cout << "ğŸ“¡ Server running on http://localhost:" << pImpl->port << std::endl;
    std::cout << "ğŸ’ Database connected successfully!" << std::endl;
    
    // ä»æ–‡ä»¶åŠ è½½çºªå¿µæ—¥æ•°æ® - ä½¿ç”¨ä¿®å¤åçš„å®‰å…¨ç‰ˆæœ¬
    safeLoadAnniversariesFromFile();
    
    // ä»æ–‡ä»¶åŠ è½½æ´»åŠ¨æ•°æ® - ä½¿ç”¨å®‰å…¨ç‰ˆæœ¬
    safeLoadActivitiesFromFile();
    
    // ä»æ–‡ä»¶åŠ è½½æ„¿æœ›æ•°æ®
    safeLoadWishesFromFile();
    
    // ä»æ–‡ä»¶åŠ è½½æ—¥è®°æ•°æ®
    safeLoadDiariesFromFile();
    
    std::cout << "ğŸ¯ HTTP Server started on port " << pImpl->port << std::endl;
    std::cout << "ğŸŒ Listening on all interfaces" << std::endl;

    // å¯åŠ¨ç®€å•çš„HTTPæœåŠ¡å™¨æ¨¡æ‹Ÿ
    std::thread serverThread([this]() {
        runSimpleServer();
    });
    serverThread.detach();
}

// åœæ­¢æœåŠ¡å™¨
void Server::stop() {
    pImpl->running = false;
    std::cout << "â¹ï¸  æœåŠ¡å™¨å·²åœæ­¢" << std::endl;
}

// æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
bool Server::isRunning() const {
    return pImpl->running;
}

// å¤„ç†GETè¯·æ±‚
std::string Server::handleGetRequest(const std::string& path) {
    std::cout << "ğŸ“¨ æ”¶åˆ°è¯·æ±‚: GET " << path << " HTTP/1.1" << std::endl;
    
    // æå–è·¯å¾„éƒ¨åˆ†ï¼Œå»æ‰æŸ¥è¯¢å‚æ•°
    std::string pathOnly = path;
    size_t queryPos = path.find("?");
    if (queryPos != std::string::npos) {
        pathOnly = path.substr(0, queryPos);
        std::cout << "ğŸ” æå–è·¯å¾„éƒ¨åˆ†: " << pathOnly << std::endl;
    }

    if (pathOnly == "/api/photos") {
        return handleGetPhotosRequest();
    } else if (pathOnly == "/api/anniversaries") {
        return handleGetAnniversariesRequest();
    } else if (pathOnly == "/api/diaries") {
        return handleGetDiariesRequest();
    } else if (pathOnly == "/api/wishes") {
        return handleGetWishesRequest();
    } else if (pathOnly == "/api/activities") {
        return handleGetActivitiesRequest();
    } else if (pathOnly == "/api/stats") {
        return handleGetStatsRequest();
    } else {
            // å¤„ç†é™æ€æ–‡ä»¶è¯·æ±‚
            std::string filePath;
            if (pathOnly == "/") {
                // æ ¹è·¯å¾„è¯·æ±‚è¿”å›index.html
                filePath = getProjectRoot() + "/frontend/index.html";
            } else if (pathOnly.find("/frontend/") == 0) {
                // å¦‚æœè·¯å¾„ä»¥/frontend/å¼€å¤´ï¼Œç›´æ¥æ˜ å°„åˆ°frontendç›®å½•
                // ä¾‹å¦‚ï¼š/frontend/images/bg.jpg -> /home/youxing/love_record/frontend/images/bg.jpg
                filePath = getProjectRoot() + pathOnly;
            } else {
                // å…¶ä»–è·¯å¾„ç›´æ¥æ˜ å°„åˆ°staticæ–‡ä»¶
                if (pathOnly.find("/frontend/") == 0) { filePath = getProjectRoot() + pathOnly; } else { filePath = getProjectRoot() + "/frontend" + pathOnly; }
            }
            return serveStaticFile(filePath);
        }
}

// å¤„ç†POSTè¯·æ±‚
std::string Server::handlePostRequest(const std::string& path, const std::string& body) {
    std::cout << "ğŸ“¨ æ”¶åˆ°è¯·æ±‚: POST " << path << " HTTP/1.1" << std::endl;

    // æå–è·¯å¾„éƒ¨åˆ†ï¼Œå»æ‰æŸ¥è¯¢å‚æ•°
    std::string pathOnly = path;
    size_t queryPos = path.find("?");
    if (queryPos != std::string::npos) {
        pathOnly = path.substr(0, queryPos);
    }

    if (pathOnly == "/api/photos") {
        return handlePostPhotosRequest(body);
    } else if (pathOnly == "/api/photos/delete") {
        return handleDeletePhotosRequest(body);
    } else if (pathOnly == "/api/anniversaries") {
        return handlePostAnniversariesRequest(body);
    } else if (pathOnly == "/api/anniversaries/delete") {
        return handleDeleteAnniversariesRequest(body);
    } else if (pathOnly == "/api/diaries") {
        return handlePostDiariesRequest(body);
    } else if (pathOnly == "/api/diaries/delete") {
        return handleDeleteDiariesRequest(body);
    } else if (pathOnly == "/api/wishes") {
        return handlePostWishesRequest(body);
    } else if (pathOnly == "/api/wishes/delete") {
        return handleDeleteWishesRequest(body);
    } else if (pathOnly == "/api/wishes/complete") {
        return handleCompleteWishRequest(body);
    } else if (pathOnly == "/api/activities") {
        return handlePostActivitiesRequest(body);
    } else {
        std::string response = "HTTP/1.1 404 Not Found\r\n";
        response += "Content-Type: application/json; charset=UTF-8\r\n";
        response += "Access-Control-Allow-Origin: *\r\n";
        response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
        response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
        response += "Connection: close\r\n";
        response += "\r\n";
        response += "{\"success\": false,\"message\": \"è·¯å¾„ä¸å­˜åœ¨\"}";
        return response;
    }
}

// å¤„ç†OPTIONSè¯·æ±‚
std::string Server::handleOptionsRequest(const std::string& path) {
    std::string response = "HTTP/1.1 204 No Content\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    return response;
}

// åŠ è½½ç…§ç‰‡åˆ—è¡¨

// å¤„ç†æ·»åŠ ç…§ç‰‡è¯·æ±‚
std::string Server::handlePostPhotosRequest(const std::string& body) {
    // è¿”å›æˆåŠŸå“åº”ï¼Œä¸å®é™…æ·»åŠ ç…§ç‰‡
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    response += "{\"success\": true,\"message\": \"ç…§ç‰‡æ·»åŠ æˆåŠŸ\",\"data\": {\"photoId\": 1}}";
    return response;
}

// å¤„ç†æ–‡ä»¶ä¸Šä¼ 
std::string Server::handlePhotoUploadRequest(const std::string& body, const std::string& filePath) {
    // ç¡®ä¿imagesç›®å½•å­˜åœ¨
    std::string imagesDir = getProjectRoot() + "/frontend/images";
    std::filesystem::create_directories(imagesDir);
    
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    
    // ç›´æ¥å°†è¯·æ±‚ä½“å†™å…¥æ–‡ä»¶ï¼Œä¿å­˜ç”¨æˆ·ä¸Šä¼ çš„å®é™…æ–‡ä»¶å†…å®¹
    std::ofstream outFile(filePath, std::ios::binary);
    if (outFile.is_open()) {
        // å†™å…¥è¯·æ±‚ä½“ï¼Œè¿™æ˜¯ç”¨æˆ·ä¸Šä¼ çš„å®é™…æ–‡ä»¶å†…å®¹
        outFile.write(body.c_str(), body.size());
        outFile.close();
        
        // éªŒè¯æ–‡ä»¶å¤§å°
        size_t fileSize = std::filesystem::file_size(filePath);
        
        // ç”ŸæˆæˆåŠŸå“åº”
            std::string photoUrl = "/frontend/images/" + std::filesystem::path(filePath).filename().string();
            response += "{\"success\": true,\"message\": \"ç…§ç‰‡ä¸Šä¼ æˆåŠŸ\",\"data\": {\"photoId\": " + std::to_string(std::time(nullptr)) + ",\"url\": \"" + photoUrl + "\"}}";
        std::cout << "ğŸ“¸ ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼Œä¿å­˜è·¯å¾„: " << filePath << "ï¼ŒURL: " << photoUrl << "ï¼Œæ–‡ä»¶å¤§å°: " << fileSize << "å­—èŠ‚" << std::endl;
    } else {
        response += "{\"success\": false,\"message\": \"æ— æ³•åˆ›å»ºæ–‡ä»¶\"}";
        std::cerr << "âŒ æ— æ³•åˆ›å»ºæ–‡ä»¶: " << filePath << std::endl;
    }
    
    return response;
}

// å¤„ç†åˆ é™¤ç…§ç‰‡è¯·æ±‚
std::string Server::handleDeletePhotosRequest(const std::string& body) {
    // è§£æè¯·æ±‚ä½“ï¼Œè·å–ç…§ç‰‡IDå’Œåç§°
    std::string photoIdStr = "";
    std::string photoName = "";
    
    // è§£æID
    size_t idPos = body.find("\"id\":");
    if (idPos != std::string::npos) {
        size_t idStart = body.find_first_of("0123456789", idPos + 5);
        if (idStart != std::string::npos) {
            size_t idEnd = body.find_first_not_of("0123456789", idStart);
            photoIdStr = body.substr(idStart, idEnd - idStart);
        }
    }
    
    // è§£æåç§°
    size_t namePos = body.find("\"name\":");
    if (namePos != std::string::npos) {
        size_t nameStart = body.find("\"", namePos + 7) + 1;
        if (nameStart != std::string::npos) {
            size_t nameEnd = body.find("\"", nameStart);
            photoName = body.substr(nameStart, nameEnd - nameStart);
        }
    }
    
    std::string imagesDir = getProjectRoot() + "/frontend/images";
    std::string fileName = "";
    
    std::cout << "ğŸ—‘ï¸  æ”¶åˆ°åˆ é™¤ç…§ç‰‡è¯·æ±‚: ID=" << photoIdStr << ", åç§°=" << photoName << std::endl;
    
    try {
        if (!photoName.empty()) {
            // ç›´æ¥ä½¿ç”¨ç…§ç‰‡åç§°åˆ é™¤æ–‡ä»¶
            fileName = photoName;
            std::string filePath = imagesDir + "/" + fileName;
            if (std::filesystem::exists(filePath)) {
                if (std::filesystem::remove(filePath)) {
                    std::cout << "ğŸ—‘ï¸  ç…§ç‰‡åˆ é™¤æˆåŠŸï¼Œæ–‡ä»¶è·¯å¾„: " << filePath << std::endl;
                } else {
                    std::cerr << "âŒ æ— æ³•åˆ é™¤ç…§ç‰‡æ–‡ä»¶: " << filePath << std::endl;
                }
            } else {
                std::cerr << "âŒ ç…§ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: " << filePath << std::endl;
            }
        } else {
            // æ ¹æ®IDæŸ¥æ‰¾æ–‡ä»¶
            for (const auto& entry : std::filesystem::directory_iterator(imagesDir)) {
                if (entry.is_regular_file()) {
                    std::string currentFileName = entry.path().filename().string();
                    size_t currentFileId = std::hash<std::string>{}(currentFileName);
                    if (std::to_string(currentFileId) == photoIdStr) {
                        fileName = currentFileName;
                        break;
                    }
                }
            }
            
            if (!fileName.empty()) {
                std::string filePath = imagesDir + "/" + fileName;
                if (std::filesystem::remove(filePath)) {
                    std::cout << "ğŸ—‘ï¸  ç…§ç‰‡åˆ é™¤æˆåŠŸï¼Œæ–‡ä»¶è·¯å¾„: " << filePath << std::endl;
                } else {
                    std::cerr << "âŒ æ— æ³•åˆ é™¤ç…§ç‰‡æ–‡ä»¶: " << filePath << std::endl;
                }
            } else {
                std::cerr << "âŒ æ— æ³•æ‰¾åˆ°å¯¹åº”çš„ç…§ç‰‡æ–‡ä»¶ï¼ŒID=" << photoIdStr << std::endl;
            }
        }
    } catch (const std::filesystem::filesystem_error& e) {
        std::cerr << "âŒ æ— æ³•æ“ä½œimagesç›®å½•: " << e.what() << std::endl;
    }
    
    // è¿”å›æˆåŠŸå“åº”
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    response += "{\"success\": true,\"message\": \"ç…§ç‰‡åˆ é™¤æˆåŠŸ\"}";
    return response;
}

// çºªå¿µæ—¥ç»“æ„ä½“å®šä¹‰
struct Anniversary {
    long long id;
    std::string title;
    std::string date;
    std::string category;
    std::string createdAt;
};

// å…¨å±€çºªå¿µæ—¥åˆ—è¡¨
std::vector<Anniversary> g_anniversaries;

// çºªå¿µæ—¥æ•°æ®å­˜å‚¨æ–‡ä»¶è·¯å¾„
const std::string ANNIVERSARIES_FILE = getProjectRoot() + "/backend/data/anniversaries.json";

// æ´»åŠ¨ç»“æ„ä½“å®šä¹‰
struct Activity {
    long long id;
    std::string type;
    std::string content;
    std::string createdAt;
    std::string operator_; // æ“ä½œè€…å­—æ®µï¼Œä½¿ç”¨operator_é¿å…ä¸C++å…³é”®å­—å†²çª
};

// å…¨å±€æ´»åŠ¨åˆ—è¡¨
std::vector<Activity> g_activities;

// æ´»åŠ¨æ•°æ®å­˜å‚¨æ–‡ä»¶è·¯å¾„
const std::string ACTIVITIES_FILE = getProjectRoot() + "/backend/data/activities.json";

// æ„¿æœ›ç»“æ„ä½“å®šä¹‰
struct Wish {
    long long id;
    std::string content;
    std::string title;
    std::string description;
    std::string category;
    bool isCompleted;
    std::string createdAt;
    std::string completedAt;
};

// å…¨å±€æ„¿æœ›åˆ—è¡¨
std::vector<Wish> g_wishes;

// æ„¿æœ›æ•°æ®å­˜å‚¨æ–‡ä»¶è·¯å¾„
const std::string WISHES_FILE = getProjectRoot() + "/backend/data/wishes.json";

// æ—¥è®°ç»“æ„ä½“å®šä¹‰
struct Diary {
    long long id;
    std::string title;
    std::string content;
    int mood;
    std::string author;
    std::string createdAt;
};

// å…¨å±€æ—¥è®°åˆ—è¡¨
std::vector<Diary> g_diaries;

// æ—¥è®°æ•°æ®å­˜å‚¨æ–‡ä»¶è·¯å¾„
const std::string DIARIES_FILE = getProjectRoot() + "/backend/data/diaries.json";

// ä»æ–‡ä»¶å®‰å…¨åŠ è½½æ´»åŠ¨æ•°æ®
void Server::safeLoadActivitiesFromFile() {
    try {
        // åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•
        std::filesystem::path dirPath = std::filesystem::path(ACTIVITIES_FILE).parent_path();
        if (!std::filesystem::exists(dirPath)) {
            std::filesystem::create_directories(dirPath);
            std::cout << "ğŸ“ å·²åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•: " << dirPath << std::endl;
        }
        
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (!std::filesystem::exists(ACTIVITIES_FILE)) {
            std::cout << "ğŸ“„ æ´»åŠ¨æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨" << std::endl;
            return;
        }
        
        // æ‰“å¼€æ–‡ä»¶å¹¶è·å–å¤§å°ï¼Œé¿å…è¯»å–è¿‡å¤§æ–‡ä»¶
        std::ifstream inFile(ACTIVITIES_FILE, std::ios::ate);
        if (!inFile.is_open()) {
            std::cerr << "âŒ æ— æ³•æ‰“å¼€æ´»åŠ¨æ•°æ®æ–‡ä»¶: " << ACTIVITIES_FILE << std::endl;
            return;
        }
        
        // è·å–æ–‡ä»¶å¤§å°ï¼Œé™åˆ¶è¯»å–å¤§å°
        std::streampos fileSize = inFile.tellg();
        inFile.seekg(0, std::ios::beg);
        
        // é™åˆ¶æ–‡ä»¶å¤§å°ï¼Œé¿å…å†…å­˜æ¶ˆè€—è¿‡é«˜
        if (fileSize > 1024 * 1024) { // é™åˆ¶ä¸º1MB
            std::cerr << "âŒ æ´»åŠ¨æ•°æ®æ–‡ä»¶è¿‡å¤§ï¼Œé™åˆ¶è¯»å–å¤§å°" << std::endl;
            inFile.close();
            return;
        }
        
        // è¯»å–æ–‡ä»¶å†…å®¹
        std::string jsonContent;
        jsonContent.resize(static_cast<size_t>(fileSize));
        inFile.read(&jsonContent[0], fileSize);
        inFile.close();
        
        // æ¸…ç©ºå…¨å±€æ´»åŠ¨åˆ—è¡¨
        g_activities.clear();
        
        // è§£æJSONæ•°æ® - ç®€åŒ–ç‰ˆï¼Œä½¿ç”¨æ›´å®‰å…¨çš„è§£ææ–¹å¼
        if (jsonContent == "[]" || jsonContent == "") {
            std::cout << "ğŸ“„ æ´»åŠ¨æ•°æ®æ–‡ä»¶ä¸ºç©ºï¼Œä½¿ç”¨ç©ºåˆ—è¡¨" << std::endl;
            return;
        }
        
        // ç®€åŒ–çš„JSONè§£æ
        size_t start = jsonContent.find('[');
        size_t end = jsonContent.rfind(']');
        if (start == std::string::npos || end == std::string::npos || start >= end) {
            std::cerr << "âŒ æ— æ•ˆçš„æ´»åŠ¨æ•°æ®æ–‡ä»¶æ ¼å¼" << std::endl;
            return;
        }
        
        // æå–æ•°ç»„å†…å®¹
        std::string arrayContent = jsonContent.substr(start + 1, end - start - 1);
        
        // åˆ†å‰²å¯¹è±¡
        size_t pos = 0;
        while (pos < arrayContent.size()) {
            // æ‰¾åˆ°å¯¹è±¡çš„å¼€å§‹å’Œç»“æŸä½ç½®
            size_t objStart = arrayContent.find('{', pos);
            if (objStart == std::string::npos) break;
            
            // æ‰¾åˆ°åŒ¹é…çš„ç»“æŸæ‹¬å·ï¼Œå¤„ç†åµŒå¥—ç»“æ„
            size_t objEnd = arrayContent.find('}', objStart + 1);
            if (objEnd == std::string::npos) break;
            
            // æ£€æŸ¥åµŒå¥—ç»“æ„ï¼Œç¡®ä¿æ‰¾åˆ°æ­£ç¡®çš„ç»“æŸæ‹¬å·
            int braceCount = 1;
            size_t tempPos = objStart + 1;
            while (tempPos < arrayContent.size() && braceCount > 0) {
                if (arrayContent[tempPos] == '{') {
                    braceCount++;
                } else if (arrayContent[tempPos] == '}') {
                    braceCount--;
                    if (braceCount == 0) {
                        objEnd = tempPos;
                        break;
                    }
                }
                tempPos++;
            }
            
            // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„ç»“æŸæ‹¬å·ï¼Œè·³è¿‡
            if (braceCount > 0) {
                std::cerr << "âš ï¸  æ‰¾ä¸åˆ°åŒ¹é…çš„ç»“æŸæ‹¬å·ï¼Œè·³è¿‡è¯¥å¯¹è±¡" << std::endl;
                pos = objStart + 1;
                continue;
            }
            
            // æå–å•ä¸ªå¯¹è±¡
            std::string objStr = arrayContent.substr(objStart, objEnd - objStart + 1);
            
            // è§£æå¯¹è±¡çš„å„ä¸ªå­—æ®µ
            Activity activity;
            
            // è§£æid - æ·»åŠ é”™è¯¯å¤„ç†ï¼Œé¿å…stoiæŠ›å‡ºå¼‚å¸¸
            size_t idPos = objStr.find("\"id\":");
            if (idPos != std::string::npos) {
                size_t idEnd = objStr.find(',', idPos + 6);
                if (idEnd == std::string::npos) {
                    idEnd = objStr.find('}', idPos + 6);
                }
                std::string idStr = objStr.substr(idPos + 6, idEnd - idPos - 6);
                try {
                    activity.id = std::stoll(idStr);
                } catch (const std::invalid_argument& e) {
                    // IDè§£æå¤±è´¥ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºé»˜è®¤ID
                    activity.id = static_cast<long long>(std::time(nullptr));
                    std::cerr << "âš ï¸  IDè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ID: " << activity.id << std::endl;
                } catch (const std::out_of_range& e) {
                    // IDè¶…å‡ºèŒƒå›´ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºé»˜è®¤ID
                    activity.id = static_cast<long long>(std::time(nullptr));
                    std::cerr << "âš ï¸  IDè¶…å‡ºèŒƒå›´ï¼Œä½¿ç”¨é»˜è®¤ID: " << activity.id << std::endl;
                }
            } else {
                // æ²¡æœ‰IDå­—æ®µï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºé»˜è®¤ID
                activity.id = static_cast<long long>(std::time(nullptr));
            }
            
            // è§£ætype
            size_t typePos = objStr.find("\"type\":");
            if (typePos != std::string::npos) {
                // æ‰¾åˆ°å†’å·ä½ç½®ï¼Œç„¶åæ‰¾ä¸‹ä¸€ä¸ªå¼•å·
                size_t colonPos = objStr.find(":", typePos);
                if (colonPos != std::string::npos) {
                    size_t typeValStart = objStr.find('"', colonPos + 1) + 1;
                    size_t typeValEnd = objStr.find('"', typeValStart);
                    if (typeValEnd > typeValStart) {
                        activity.type = objStr.substr(typeValStart, typeValEnd - typeValStart);
                    }
                }
            }
            
            // è§£æcontent
            size_t contentPos = objStr.find("\"content\":");
            if (contentPos != std::string::npos) {
                // æ‰¾åˆ°å†’å·ä½ç½®ï¼Œç„¶åæ‰¾ä¸‹ä¸€ä¸ªå¼•å·
                size_t colonPos = objStr.find(":", contentPos);
                if (colonPos != std::string::npos) {
                    size_t contentValStart = objStr.find('"', colonPos + 1) + 1;
                    size_t contentValEnd = objStr.find('"', contentValStart);
                    if (contentValEnd > contentValStart) {
                        activity.content = objStr.substr(contentValStart, contentValEnd - contentValStart);
                    }
                }
            }
            
            // è§£æcreatedAt
            size_t createdAtPos = objStr.find("\"createdAt\":");
            if (createdAtPos != std::string::npos) {
                // æ‰¾åˆ°å†’å·ä½ç½®ï¼Œç„¶åæ‰¾ä¸‹ä¸€ä¸ªå¼•å·
                size_t colonPos = objStr.find(":", createdAtPos);
                if (colonPos != std::string::npos) {
                    size_t createdAtValStart = objStr.find('"', colonPos + 1) + 1;
                    size_t createdAtValEnd = objStr.find('"', createdAtValStart);
                    if (createdAtValEnd > createdAtValStart) {
                        activity.createdAt = objStr.substr(createdAtValStart, createdAtValEnd - createdAtValStart);
                    }
                }
            } else {
                // å¦‚æœæ²¡æœ‰createdAtå­—æ®µï¼Œç”Ÿæˆå½“å‰æ—¶é—´
                auto now = std::chrono::system_clock::now();
                auto now_c = std::chrono::system_clock::to_time_t(now);
                std::stringstream createdAtStream;
                createdAtStream << std::put_time(std::localtime(&now_c), "%Y-%m-%dT%H:%M:%S");
                activity.createdAt = createdAtStream.str();
            }
            
            // è§£æoperatorå­—æ®µ
            size_t operatorPos = objStr.find("\"operator\":");
            if (operatorPos != std::string::npos) {
                // æ‰¾åˆ°å†’å·ä½ç½®ï¼Œç„¶åæ‰¾ä¸‹ä¸€ä¸ªå¼•å·
                size_t colonPos = objStr.find(":", operatorPos);
                if (colonPos != std::string::npos) {
                    size_t operatorValStart = objStr.find('"', colonPos + 1) + 1;
                    size_t operatorValEnd = objStr.find('"', operatorValStart);
                    if (operatorValEnd > operatorValStart) {
                        activity.operator_ = objStr.substr(operatorValStart, operatorValEnd - operatorValStart);
                    }
                }
            } else {
                // å¦‚æœæ²¡æœ‰operatorå­—æ®µï¼Œé»˜è®¤å€¼ä¸ºç©ºå­—ç¬¦ä¸²
                activity.operator_ = "";
            }
            
            // åªæœ‰æœ‰æ•ˆçš„æ´»åŠ¨æ‰æ·»åŠ åˆ°å…¨å±€åˆ—è¡¨ä¸­
            // éªŒè¯æ´»åŠ¨æ˜¯å¦æœ‰æ•ˆï¼š
            // 1. æ‰€æœ‰å­—æ®µä¸èƒ½ä¸ºç©º
            // 2. ä¸èƒ½åŒ…å«æ— æ•ˆå­—ç¬¦ï¼ˆå¦‚é€—å·ã€å³æ‹¬å·ç­‰ï¼‰
            // 3. createdAtå¿…é¡»æ˜¯æœ‰æ•ˆçš„æ—¶é—´æ ¼å¼ï¼ˆè‡³å°‘åŒ…å«"-"å’Œ"T"ï¼‰
            if (!activity.content.empty() && !activity.type.empty() && !activity.createdAt.empty() &&
                activity.content != "," && activity.content != "\"" && activity.content != "}" &&
                activity.type != "," && activity.type != "\"" && activity.type != "}" &&
                activity.createdAt.find("-") != std::string::npos && activity.createdAt.find("T") != std::string::npos) {
                g_activities.push_back(activity);
                std::cout << "ğŸ“ åŠ è½½äº†ä¸€ä¸ªæœ‰æ•ˆæ´»åŠ¨: " << activity.content << "ï¼Œæ“ä½œè€…: " << activity.operator_ << std::endl;
            } else {
                std::cerr << "âš ï¸  è·³è¿‡æ— æ•ˆæ´»åŠ¨: content='" << activity.content << "', type='" << activity.type << "', createdAt='" << activity.createdAt << "', operator='" << activity.operator_ << "'" << std::endl;
            }
            
            // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¯¹è±¡
            pos = objEnd + 2; // è·³è¿‡é€—å·å’Œç©ºæ ¼
        }
        
        std::cout << "ğŸ“¥ å·²ä»æ–‡ä»¶åŠ è½½ " << g_activities.size() << " ä¸ªæ´»åŠ¨æ•°æ®" << std::endl;
    } catch (const std::exception& e) {
        std::cerr << "âŒ åŠ è½½æ´»åŠ¨æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸: " << e.what() << std::endl;
        // å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨
        g_activities.clear();
    } catch (...) {
        std::cerr << "âŒ åŠ è½½æ´»åŠ¨æ•°æ®æ—¶å‘ç”ŸæœªçŸ¥å¼‚å¸¸" << std::endl;
        // å‘ç”ŸæœªçŸ¥å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨
        g_activities.clear();
    }
}

// å°†æ´»åŠ¨æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
void Server::saveActivitiesToFile() {
    try {
        // åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•
        std::filesystem::path dirPath = std::filesystem::path(ACTIVITIES_FILE).parent_path();
        if (!std::filesystem::exists(dirPath)) {
            std::filesystem::create_directories(dirPath);
        }
        
        std::ofstream outFile(ACTIVITIES_FILE, std::ios::trunc);
        if (!outFile.is_open()) {
            std::cerr << "âŒ æ— æ³•æ‰“å¼€æ´»åŠ¨æ•°æ®æ–‡ä»¶è¿›è¡Œå†™å…¥: " << ACTIVITIES_FILE << std::endl;
            return;
        }
        
        // æ„å»ºJSONæ•°ç»„
        outFile << "[";
        
        for (size_t i = 0; i < g_activities.size(); i++) {
            const Activity& a = g_activities[i];
            
            if (i > 0) {
                outFile << ",";
            }
            
            // å†™å…¥å•ä¸ªæ´»åŠ¨çš„JSONå¯¹è±¡
            outFile << "{\"id\":" << a.id << ",";
            outFile << "\"type\":\"" << a.type << "\",";
            outFile << "\"content\":\"" << a.content << "\",";
            outFile << "\"createdAt\":\"" << a.createdAt << "\",";
            outFile << "\"operator\":\"" << a.operator_ << "\"}";
        }
        
        outFile << "]";
        
        // æ£€æŸ¥å†™å…¥æ˜¯å¦æˆåŠŸ
        if (outFile.fail()) {
            std::cerr << "âŒ å†™å…¥æ´»åŠ¨æ•°æ®æ–‡ä»¶å¤±è´¥" << std::endl;
        } else {
            std::cout << "ğŸ’¾ å·²å°† " << g_activities.size() << " ä¸ªæ´»åŠ¨æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶: " << ACTIVITIES_FILE << std::endl;
        }
        
        outFile.close();
    } catch (const std::exception& e) {
        std::cerr << "âŒ ä¿å­˜æ´»åŠ¨æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸: " << e.what() << std::endl;
    } catch (...) {
        std::cerr << "âŒ ä¿å­˜æ´»åŠ¨æ•°æ®æ—¶å‘ç”ŸæœªçŸ¥å¼‚å¸¸" << std::endl;
    }
}

// ä»æ–‡ä»¶å®‰å…¨åŠ è½½æ„¿æœ›æ•°æ®
void Server::safeLoadWishesFromFile() {
    try {
        // åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•
        std::filesystem::path dirPath = std::filesystem::path(WISHES_FILE).parent_path();
        if (!std::filesystem::exists(dirPath)) {
            std::filesystem::create_directories(dirPath);
            std::cout << "ğŸ“ å·²åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•: " << dirPath << std::endl;
        }
        
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (!std::filesystem::exists(WISHES_FILE)) {
            std::cout << "ğŸ“„ æ„¿æœ›æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨" << std::endl;
            return;
        }
        
        // æ‰“å¼€æ–‡ä»¶å¹¶è·å–å¤§å°ï¼Œé¿å…è¯»å–è¿‡å¤§æ–‡ä»¶
        std::ifstream inFile(WISHES_FILE, std::ios::ate);
        if (!inFile.is_open()) {
            std::cerr << "âŒ æ— æ³•æ‰“å¼€æ„¿æœ›æ•°æ®æ–‡ä»¶: " << WISHES_FILE << std::endl;
            return;
        }
        
        // è·å–æ–‡ä»¶å¤§å°ï¼Œé™åˆ¶è¯»å–å¤§å°
        std::streampos fileSize = inFile.tellg();
        inFile.seekg(0, std::ios::beg);
        
        // é™åˆ¶æ–‡ä»¶å¤§å°ï¼Œé¿å…å†…å­˜æ¶ˆè€—è¿‡é«˜
        if (fileSize > 1024 * 1024) { // é™åˆ¶ä¸º1MB
            std::cerr << "âŒ æ„¿æœ›æ•°æ®æ–‡ä»¶è¿‡å¤§ï¼Œé™åˆ¶è¯»å–å¤§å°" << std::endl;
            inFile.close();
            return;
        }
        
        // è¯»å–æ–‡ä»¶å†…å®¹
        std::string jsonContent;
        jsonContent.resize(static_cast<size_t>(fileSize));
        inFile.read(&jsonContent[0], fileSize);
        inFile.close();
        
        // æ¸…ç©ºå…¨å±€æ„¿æœ›åˆ—è¡¨
        g_wishes.clear();
        
        // è§£æJSONæ•°æ® - ç®€åŒ–ç‰ˆï¼Œä½¿ç”¨æ›´å®‰å…¨çš„è§£ææ–¹å¼
        if (jsonContent == "[]" || jsonContent == "") {
            std::cout << "ğŸ“„ æ„¿æœ›æ•°æ®æ–‡ä»¶ä¸ºç©ºï¼Œä½¿ç”¨ç©ºåˆ—è¡¨" << std::endl;
            return;
        }
        
        // ç®€åŒ–çš„JSONè§£æ
        size_t start = jsonContent.find('[');
        size_t end = jsonContent.rfind(']');
        if (start == std::string::npos || end == std::string::npos || start >= end) {
            std::cerr << "âŒ æ— æ•ˆçš„æ„¿æœ›æ•°æ®æ–‡ä»¶æ ¼å¼" << std::endl;
            return;
        }
        
        // æå–æ•°ç»„å†…å®¹
        std::string arrayContent = jsonContent.substr(start + 1, end - start - 1);
        
        // åˆ†å‰²å¯¹è±¡
        size_t pos = 0;
        while (pos < arrayContent.size()) {
            // æ‰¾åˆ°å¯¹è±¡çš„å¼€å§‹å’Œç»“æŸä½ç½®
            size_t objStart = arrayContent.find('{', pos);
            if (objStart == std::string::npos) break;
            
            size_t objEnd = arrayContent.find('}', objStart + 1);
            if (objEnd == std::string::npos) break;
            
            // æå–å•ä¸ªå¯¹è±¡
            std::string objStr = arrayContent.substr(objStart, objEnd - objStart + 1);
            
            // è§£æå¯¹è±¡çš„å„ä¸ªå­—æ®µ
            Wish wish;
            
            // è§£æid - æ·»åŠ é”™è¯¯å¤„ç†
            size_t idPos = objStr.find("\"id\":");
            if (idPos != std::string::npos) {
                // æ‰¾åˆ°idå­—æ®µçš„å€¼å¼€å§‹ä½ç½®ï¼Œè·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
                size_t idValueStart = objStr.find(":", idPos) + 1;
                idValueStart = objStr.find_first_not_of(" \t\r\n", idValueStart);
                
                if (idValueStart != std::string::npos) {
                    // æ£€æŸ¥å€¼æ˜¯å¦è¢«å¼•å·åŒ…å›´
                    if (objStr[idValueStart] == '"') {
                        // å­—ç¬¦ä¸²ç±»å‹çš„IDï¼Œæ‰¾åˆ°ç»“å°¾å¼•å·
                        idValueStart++;
                        size_t idEnd = objStr.find('"', idValueStart);
                        if (idEnd != std::string::npos) {
                            std::string idStr = objStr.substr(idValueStart, idEnd - idValueStart);
                            try {
                                wish.id = std::stoll(idStr);
                            } catch (const std::exception& e) {
                                // IDè§£æå¤±è´¥ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºé»˜è®¤ID
                                wish.id = static_cast<long long>(std::time(nullptr));
                                std::cerr << "âš ï¸  æ„¿æœ›IDè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ID: " << wish.id << std::endl;
                            }
                        } else {
                            // æ²¡æœ‰æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºé»˜è®¤ID
                            wish.id = static_cast<long long>(std::time(nullptr));
                            std::cerr << "âš ï¸  æ„¿æœ›IDè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ID: " << wish.id << std::endl;
                        }
                    } else {
                        // æ•°å­—ç±»å‹çš„IDï¼Œæ‰¾åˆ°å€¼çš„ç»“å°¾
                        size_t idEnd = objStr.find_first_of(",}", idValueStart);
                        std::string idStr = objStr.substr(idValueStart, idEnd - idValueStart);
                        try {
                            wish.id = std::stoll(idStr);
                        } catch (const std::exception& e) {
                            // IDè§£æå¤±è´¥ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºé»˜è®¤ID
                            wish.id = static_cast<long long>(std::time(nullptr));
                            std::cerr << "âš ï¸  æ„¿æœ›IDè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ID: " << wish.id << std::endl;
                        }
                    }
                } else {
                    // æ²¡æœ‰æ‰¾åˆ°IDå€¼ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºé»˜è®¤ID
                    wish.id = static_cast<long long>(std::time(nullptr));
                    std::cerr << "âš ï¸  æ„¿æœ›IDè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ID: " << wish.id << std::endl;
                }
            } else {
                // æ²¡æœ‰IDå­—æ®µï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºé»˜è®¤ID
                wish.id = static_cast<long long>(std::time(nullptr));
            }
            
            // è§£æcontent
            size_t contentPos = objStr.find("\"content\":");
            if (contentPos != std::string::npos) {
                // æ‰¾åˆ°":"çš„ä½ç½®
                size_t colonPos = objStr.find(":", contentPos);
                if (colonPos != std::string::npos) {
                    // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
                    size_t contentValStart = objStr.find('"', colonPos + 1);
                    if (contentValStart != std::string::npos) {
                        // è·³è¿‡å¼€å¤´å¼•å·
                        contentValStart++;
                        // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰å¼•å·çš„æƒ…å†µ
                        size_t contentValEnd = contentValStart;
                        bool inEscape = false;
                        while (contentValEnd < objStr.size()) {
                            if (objStr[contentValEnd] == '\\') {
                                inEscape = !inEscape;
                            } else if (objStr[contentValEnd] == '"' && !inEscape) {
                                break;
                            } else {
                                inEscape = false;
                            }
                            contentValEnd++;
                        }
                        if (contentValEnd > contentValStart) {
                            wish.content = objStr.substr(contentValStart, contentValEnd - contentValStart);
                        }
                    }
                }
            }
            
            // è§£ætitle
            size_t titlePos = objStr.find("\"title\":");
            if (titlePos != std::string::npos) {
                // æ‰¾åˆ°":"çš„ä½ç½®
                size_t colonPos = objStr.find(":", titlePos);
                if (colonPos != std::string::npos) {
                    // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
                    size_t titleValStart = objStr.find('"', colonPos + 1);
                    if (titleValStart != std::string::npos) {
                        // è·³è¿‡å¼€å¤´å¼•å·
                        titleValStart++;
                        // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰å¼•å·çš„æƒ…å†µ
                        size_t titleValEnd = titleValStart;
                        bool inEscape = false;
                        while (titleValEnd < objStr.size()) {
                            if (objStr[titleValEnd] == '\\') {
                                inEscape = !inEscape;
                            } else if (objStr[titleValEnd] == '"' && !inEscape) {
                                break;
                            } else {
                                inEscape = false;
                            }
                            titleValEnd++;
                        }
                        if (titleValEnd > titleValStart) {
                            wish.title = objStr.substr(titleValStart, titleValEnd - titleValStart);
                        }
                    }
                }
            } else {
                // å¦‚æœæ²¡æœ‰titleå­—æ®µï¼Œä½¿ç”¨contentä½œä¸ºtitle
                wish.title = wish.content;
            }
            
            // è§£ædescription
            size_t descriptionPos = objStr.find("\"description\":");
            if (descriptionPos != std::string::npos) {
                // æ‰¾åˆ°":"çš„ä½ç½®
                size_t colonPos = objStr.find(":", descriptionPos);
                if (colonPos != std::string::npos) {
                    // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
                    size_t descValStart = objStr.find('"', colonPos + 1);
                    if (descValStart != std::string::npos) {
                        // è·³è¿‡å¼€å¤´å¼•å·
                        descValStart++;
                        // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰å¼•å·çš„æƒ…å†µ
                        size_t descValEnd = descValStart;
                        bool inEscape = false;
                        while (descValEnd < objStr.size()) {
                            if (objStr[descValEnd] == '\\') {
                                inEscape = !inEscape;
                            } else if (objStr[descValEnd] == '"' && !inEscape) {
                                break;
                            } else {
                                inEscape = false;
                            }
                            descValEnd++;
                        }
                        if (descValEnd > descValStart) {
                            wish.description = objStr.substr(descValStart, descValEnd - descValStart);
                        }
                    }
                }
            }
            
            // è§£æcategory
            size_t categoryPos = objStr.find("\"category\":");
            if (categoryPos != std::string::npos) {
                // æ‰¾åˆ°":"çš„ä½ç½®
                size_t colonPos = objStr.find(":", categoryPos);
                if (colonPos != std::string::npos) {
                    // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
                    size_t catValStart = objStr.find('"', colonPos + 1);
                    if (catValStart != std::string::npos) {
                        // è·³è¿‡å¼€å¤´å¼•å·
                        catValStart++;
                        // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰å¼•å·çš„æƒ…å†µ
                        size_t catValEnd = catValStart;
                        bool inEscape = false;
                        while (catValEnd < objStr.size()) {
                            if (objStr[catValEnd] == '\\') {
                                inEscape = !inEscape;
                            } else if (objStr[catValEnd] == '"' && !inEscape) {
                                break;
                            } else {
                                inEscape = false;
                            }
                            catValEnd++;
                        }
                        if (catValEnd > catValStart) {
                            wish.category = objStr.substr(catValStart, catValEnd - catValStart);
                        }
                    }
                }
            } else {
                // å¦‚æœæ²¡æœ‰categoryå­—æ®µï¼Œä½¿ç”¨é»˜è®¤å€¼
                wish.category = "å…¶ä»–";
            }
            
            // è§£æisCompleted
            size_t completedPos = objStr.find("\"isCompleted\":");
            if (completedPos != std::string::npos) {
                // æ‰¾åˆ°":"çš„ä½ç½®
                size_t colonPos = objStr.find(":", completedPos);
                if (colonPos != std::string::npos) {
                    // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
                    size_t completedValStart = objStr.find_first_not_of(" \t\r\n", colonPos + 1);
                    if (completedValStart != std::string::npos) {
                        // æ‰¾åˆ°å€¼çš„ç»“æŸä½ç½®ï¼ˆé€—å·æˆ–å³æ‹¬å·ï¼‰
                        size_t completedValEnd = objStr.find(',', completedValStart);
                        if (completedValEnd == std::string::npos) {
                            completedValEnd = objStr.find('}', completedValStart);
                        }
                        std::string completedStr = objStr.substr(completedValStart, completedValEnd - completedValStart);
                        wish.isCompleted = (completedStr == "1" || completedStr == "true");
                    } else {
                        wish.isCompleted = false;
                    }
                } else {
                    wish.isCompleted = false;
                }
            } else {
                wish.isCompleted = false;
            }
            
            // è§£æcreatedAt
            size_t createdAtPos = objStr.find("\"createdAt\":");
            if (createdAtPos != std::string::npos) {
                // æ‰¾åˆ°":"çš„ä½ç½®
                size_t colonPos = objStr.find(":", createdAtPos);
                if (colonPos != std::string::npos) {
                    // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
                    size_t createdAtValStart = objStr.find('"', colonPos + 1);
                    if (createdAtValStart != std::string::npos) {
                        // è·³è¿‡å¼€å¤´å¼•å·
                        createdAtValStart++;
                        // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰å¼•å·çš„æƒ…å†µ
                        size_t createdAtValEnd = createdAtValStart;
                        bool inEscape = false;
                        while (createdAtValEnd < objStr.size()) {
                            if (objStr[createdAtValEnd] == '\\') {
                                inEscape = !inEscape;
                            } else if (objStr[createdAtValEnd] == '"' && !inEscape) {
                                break;
                            } else {
                                inEscape = false;
                            }
                            createdAtValEnd++;
                        }
                        if (createdAtValEnd > createdAtValStart) {
                            wish.createdAt = objStr.substr(createdAtValStart, createdAtValEnd - createdAtValStart);
                        } else {
                            // å¦‚æœæ²¡æœ‰createdAtå­—æ®µï¼Œç”Ÿæˆå½“å‰æ—¶é—´
                            auto now = std::chrono::system_clock::now();
                            auto now_c = std::chrono::system_clock::to_time_t(now);
                            std::stringstream createdAtStream;
                            createdAtStream << std::put_time(std::localtime(&now_c), "%Y-%m-%dT%H:%M:%S");
                            wish.createdAt = createdAtStream.str();
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰createdAtå­—æ®µï¼Œç”Ÿæˆå½“å‰æ—¶é—´
                        auto now = std::chrono::system_clock::now();
                        auto now_c = std::chrono::system_clock::to_time_t(now);
                        std::stringstream createdAtStream;
                        createdAtStream << std::put_time(std::localtime(&now_c), "%Y-%m-%dT%H:%M:%S");
                        wish.createdAt = createdAtStream.str();
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰createdAtå­—æ®µï¼Œç”Ÿæˆå½“å‰æ—¶é—´
                    auto now = std::chrono::system_clock::now();
                    auto now_c = std::chrono::system_clock::to_time_t(now);
                    std::stringstream createdAtStream;
                    createdAtStream << std::put_time(std::localtime(&now_c), "%Y-%m-%dT%H:%M:%S");
                    wish.createdAt = createdAtStream.str();
                }
            } else {
                // å¦‚æœæ²¡æœ‰createdAtå­—æ®µï¼Œç”Ÿæˆå½“å‰æ—¶é—´
                auto now = std::chrono::system_clock::now();
                auto now_c = std::chrono::system_clock::to_time_t(now);
                std::stringstream createdAtStream;
                createdAtStream << std::put_time(std::localtime(&now_c), "%Y-%m-%dT%H:%M:%S");
                wish.createdAt = createdAtStream.str();
            }
            
            // è§£æcompletedAt
            size_t completedAtPos = objStr.find("\"completedAt\":");
            if (completedAtPos != std::string::npos) {
                // æ‰¾åˆ°":"çš„ä½ç½®
                size_t colonPos = objStr.find(":", completedAtPos);
                if (colonPos != std::string::npos) {
                    // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
                    size_t completedAtValStart = objStr.find('"', colonPos + 1);
                    if (completedAtValStart != std::string::npos) {
                        // è·³è¿‡å¼€å¤´å¼•å·
                        completedAtValStart++;
                        // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰å¼•å·çš„æƒ…å†µ
                        size_t completedAtValEnd = completedAtValStart;
                        bool inEscape = false;
                        while (completedAtValEnd < objStr.size()) {
                            if (objStr[completedAtValEnd] == '\\') {
                                inEscape = !inEscape;
                            } else if (objStr[completedAtValEnd] == '"' && !inEscape) {
                                break;
                            } else {
                                inEscape = false;
                            }
                            completedAtValEnd++;
                        }
                        if (completedAtValEnd > completedAtValStart) {
                            wish.completedAt = objStr.substr(completedAtValStart, completedAtValEnd - completedAtValStart);
                        } else {
                            wish.completedAt = "";
                        }
                    } else {
                        wish.completedAt = "";
                    }
                } else {
                    wish.completedAt = "";
                }
            } else {
                wish.completedAt = "";
            }
            
            // åªæœ‰æœ‰æ•ˆçš„æ„¿æœ›æ‰æ·»åŠ åˆ°å…¨å±€åˆ—è¡¨ä¸­
            if (!wish.content.empty() && wish.content != "," && wish.content != "\"" && wish.content != "}") {
                g_wishes.push_back(wish);
                std::cout << "ğŸ“ åŠ è½½äº†ä¸€ä¸ªæœ‰æ•ˆæ„¿æœ›: " << wish.content << ", å®ŒæˆçŠ¶æ€: " << (wish.isCompleted ? "å·²å®Œæˆ" : "æœªå®Œæˆ") << std::endl;
            } else {
                std::cerr << "âš ï¸  è·³è¿‡æ— æ•ˆæ„¿æœ›: content='" << wish.content << "'" << std::endl;
            }
            
            // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¯¹è±¡
            pos = objEnd + 2; // è·³è¿‡é€—å·å’Œç©ºæ ¼
        }
        
        std::cout << "ğŸ“¥ å·²ä»æ–‡ä»¶åŠ è½½ " << g_wishes.size() << " ä¸ªæ„¿æœ›æ•°æ®" << std::endl;
    } catch (const std::exception& e) {
        std::cerr << "âŒ åŠ è½½æ„¿æœ›æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸: " << e.what() << std::endl;
        // å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨
        g_wishes.clear();
    } catch (...) {
        std::cerr << "âŒ åŠ è½½æ„¿æœ›æ•°æ®æ—¶å‘ç”ŸæœªçŸ¥å¼‚å¸¸" << std::endl;
        // å‘ç”ŸæœªçŸ¥å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨
        g_wishes.clear();
    }
}

// ä»æ–‡ä»¶å®‰å…¨åŠ è½½æ—¥è®°æ•°æ®
void Server::safeLoadDiariesFromFile() {
    try {
        // åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•
        std::filesystem::path dirPath = std::filesystem::path(DIARIES_FILE).parent_path();
        if (!std::filesystem::exists(dirPath)) {
            std::filesystem::create_directories(dirPath);
            std::cout << "ğŸ“ å·²åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•: " << dirPath << std::endl;
        }
        
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (!std::filesystem::exists(DIARIES_FILE)) {
            std::cout << "ğŸ“„ æ—¥è®°æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨" << std::endl;
            return;
        }
        
        // æ‰“å¼€æ–‡ä»¶å¹¶è·å–å¤§å°ï¼Œé¿å…è¯»å–è¿‡å¤§æ–‡ä»¶
        std::ifstream inFile(DIARIES_FILE, std::ios::ate);
        if (!inFile.is_open()) {
            std::cerr << "âŒ æ— æ³•æ‰“å¼€æ—¥è®°æ•°æ®æ–‡ä»¶: " << DIARIES_FILE << std::endl;
            return;
        }
        
        // è·å–æ–‡ä»¶å¤§å°ï¼Œé™åˆ¶è¯»å–å¤§å°
        std::streampos fileSize = inFile.tellg();
        inFile.seekg(0, std::ios::beg);
        
        // é™åˆ¶æ–‡ä»¶å¤§å°ï¼Œé¿å…å†…å­˜æ¶ˆè€—è¿‡é«˜
        if (fileSize > 1024 * 1024) { // é™åˆ¶ä¸º1MB
            std::cerr << "âŒ æ—¥è®°æ•°æ®æ–‡ä»¶è¿‡å¤§ï¼Œé™åˆ¶è¯»å–å¤§å°" << std::endl;
            inFile.close();
            return;
        }
        
        // è¯»å–æ–‡ä»¶å†…å®¹
        std::string jsonContent;
        jsonContent.resize(static_cast<size_t>(fileSize));
        inFile.read(&jsonContent[0], fileSize);
        inFile.close();
        
        // æ¸…ç©ºå…¨å±€æ—¥è®°åˆ—è¡¨
        g_diaries.clear();
        
        // è§£æJSONæ•°æ®
        if (jsonContent == "[]" || jsonContent == "") {
            std::cout << "ğŸ“„ æ—¥è®°æ•°æ®æ–‡ä»¶ä¸ºç©ºï¼Œä½¿ç”¨ç©ºåˆ—è¡¨" << std::endl;
            return;
        }
        
        // ç®€åŒ–çš„JSONè§£æ
        size_t start = jsonContent.find('[');
        size_t end = jsonContent.rfind(']');
        if (start == std::string::npos || end == std::string::npos || start >= end) {
            std::cerr << "âŒ æ— æ•ˆçš„æ—¥è®°æ•°æ®æ–‡ä»¶æ ¼å¼" << std::endl;
            return;
        }
        
        // æå–æ•°ç»„å†…å®¹
        std::string arrayContent = jsonContent.substr(start + 1, end - start - 1);
        
        // åˆ†å‰²å¯¹è±¡
        size_t pos = 0;
        while (pos < arrayContent.size()) {
            // æ‰¾åˆ°å¯¹è±¡çš„å¼€å§‹å’Œç»“æŸä½ç½®
            size_t objStart = arrayContent.find('{', pos);
            if (objStart == std::string::npos) break;
            
            size_t objEnd = arrayContent.find('}', objStart + 1);
            if (objEnd == std::string::npos) break;
            
            // æå–å•ä¸ªå¯¹è±¡
            std::string objStr = arrayContent.substr(objStart, objEnd - objStart + 1);
            
            // è§£æå¯¹è±¡çš„å„ä¸ªå­—æ®µ
            Diary diary;
            
            // è§£æid
            size_t idPos = objStr.find("\"id\":");
            if (idPos != std::string::npos) {
                size_t colonPos = objStr.find(":", idPos);
                if (colonPos != std::string::npos) {
                    size_t idValStart = objStr.find_first_of("0123456789", colonPos + 1);
                    if (idValStart != std::string::npos) {
                        size_t idValEnd = objStr.find_first_not_of("0123456789", idValStart);
                        std::string idStr = objStr.substr(idValStart, idValEnd - idValStart);
                        try {
                            diary.id = std::stoll(idStr);
                        } catch (...) {
                            diary.id = static_cast<long long>(std::time(nullptr));
                            std::cerr << "âš ï¸  æ—¥è®°IDè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ID: " << diary.id << std::endl;
                        }
                    }
                }
            } else {
                diary.id = static_cast<long long>(std::time(nullptr));
            }
            
            // è§£ætitle
            size_t titlePos = objStr.find("\"title\":");
            if (titlePos != std::string::npos) {
                size_t colonPos = objStr.find(":", titlePos);
                if (colonPos != std::string::npos) {
                    size_t titleValStart = objStr.find('"', colonPos + 1);
                    if (titleValStart != std::string::npos) {
                        titleValStart++;
                        size_t titleValEnd = objStr.find('"', titleValStart);
                        if (titleValEnd > titleValStart) {
                            diary.title = objStr.substr(titleValStart, titleValEnd - titleValStart);
                        }
                    }
                }
            }
            
            // è§£æcontent
            size_t contentPos = objStr.find("\"content\":");
            if (contentPos != std::string::npos) {
                size_t colonPos = objStr.find(":", contentPos);
                if (colonPos != std::string::npos) {
                    size_t contentValStart = objStr.find('"', colonPos + 1);
                    if (contentValStart != std::string::npos) {
                        contentValStart++;
                        size_t contentValEnd = contentValStart;
                        bool inEscape = false;
                        while (contentValEnd < objStr.size()) {
                            if (objStr[contentValEnd] == '\\') {
                                inEscape = !inEscape;
                            } else if (objStr[contentValEnd] == '"' && !inEscape) {
                                break;
                            } else {
                                inEscape = false;
                            }
                            contentValEnd++;
                        }
                        if (contentValEnd > contentValStart) {
                            diary.content = objStr.substr(contentValStart, contentValEnd - contentValStart);
                        }
                    }
                }
            }
            
            // è§£æmood
            size_t moodPos = objStr.find("\"mood\":");
            if (moodPos != std::string::npos) {
                size_t colonPos = objStr.find(":", moodPos);
                if (colonPos != std::string::npos) {
                    size_t moodValStart = objStr.find_first_of("0123456789", colonPos + 1);
                    if (moodValStart != std::string::npos) {
                        size_t moodValEnd = objStr.find_first_not_of("0123456789", moodValStart);
                        std::string moodStr = objStr.substr(moodValStart, moodValEnd - moodValStart);
                        try {
                            diary.mood = std::stoi(moodStr);
                        } catch (...) {
                            diary.mood = 3; // é»˜è®¤å¿ƒæƒ…å€¼
                        }
                    }
                }
            } else {
                diary.mood = 3; // é»˜è®¤å¿ƒæƒ…å€¼
            }
            
            // è§£æauthor - æ”¹è¿›çš„è§£ææ–¹æ³•ï¼Œå¤„ç†å¤æ‚å†…å®¹
            size_t authorPos = objStr.find("\"author\":");
            if (authorPos != std::string::npos) {
                size_t colonPos = objStr.find(":", authorPos);
                if (colonPos != std::string::npos) {
                    // è·³è¿‡å†’å·å’Œå¯èƒ½çš„ç©ºæ ¼
                    size_t afterColon = colonPos + 1;
                    while (afterColon < objStr.size() && (objStr[afterColon] == ' ' || objStr[afterColon] == '\t')) {
                        afterColon++;
                    }
                    
                    if (afterColon < objStr.size() && objStr[afterColon] == '"') {
                        // æ‰¾åˆ°å¼€å§‹å¼•å·ï¼Œç°åœ¨æŸ¥æ‰¾å¯¹åº”çš„ç»“æŸå¼•å·ï¼ˆå¤„ç†è½¬ä¹‰æƒ…å†µï¼‰
                        size_t authorValStart = afterColon + 1;
                        size_t authorValEnd = authorValStart;
                        bool inEscape = false;
                        
                        while (authorValEnd < objStr.size()) {
                            if (objStr[authorValEnd] == '\\') {
                                inEscape = !inEscape;
                                authorValEnd++;
                            } else if (objStr[authorValEnd] == '"' && !inEscape) {
                                break;
                            } else {
                                inEscape = false;
                                authorValEnd++;
                            }
                        }
                        
                        if (authorValEnd < objStr.size()) {
                            diary.author = objStr.substr(authorValStart, authorValEnd - authorValStart);
                        } else {
                            diary.author = "æœªçŸ¥ä½œè€…";
                        }
                    } else {
                        // å¤„ç†éå­—ç¬¦ä¸²ç±»å‹çš„authorï¼ˆè™½ç„¶ä¸åº”è¯¥å‘ç”Ÿï¼‰
                        diary.author = "æœªçŸ¥ä½œè€…";
                    }
                }
            } else {
                diary.author = "æœªçŸ¥ä½œè€…";
            }
            
            // è§£æcreatedAt
            size_t createdAtPos = objStr.find("\"createdAt\":");
            if (createdAtPos != std::string::npos) {
                size_t colonPos = objStr.find(":", createdAtPos);
                if (colonPos != std::string::npos) {
                    size_t createdAtValStart = objStr.find('"', colonPos + 1);
                    if (createdAtValStart != std::string::npos) {
                        createdAtValStart++;
                        size_t createdAtValEnd = objStr.find('"', createdAtValStart);
                        if (createdAtValEnd > createdAtValStart) {
                            diary.createdAt = objStr.substr(createdAtValStart, createdAtValEnd - createdAtValStart);
                        }
                    }
                }
            } else {
                auto now = std::chrono::system_clock::now();
                auto now_c = std::chrono::system_clock::to_time_t(now);
                std::stringstream createdAtStream;
                createdAtStream << std::put_time(std::localtime(&now_c), "%Y-%m-%dT%H:%M:%S");
                diary.createdAt = createdAtStream.str();
            }
            
            // åªæœ‰æœ‰æ•ˆçš„æ—¥è®°æ‰æ·»åŠ åˆ°å…¨å±€åˆ—è¡¨ä¸­
            if (!diary.title.empty() || !diary.content.empty()) {
                g_diaries.push_back(diary);
                std::cout << "ğŸ“ åŠ è½½äº†ä¸€ç¯‡æœ‰æ•ˆæ—¥è®°: " << diary.title << ", å¿ƒæƒ…: " << diary.mood << std::endl;
            } else {
                std::cerr << "âš ï¸  è·³è¿‡æ— æ•ˆæ—¥è®°: æ ‡é¢˜å’Œå†…å®¹éƒ½ä¸ºç©º" << std::endl;
            }
            
            // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¯¹è±¡
            pos = objEnd + 2; // è·³è¿‡é€—å·å’Œç©ºæ ¼
        }
        
        std::cout << "ğŸ“¥ å·²ä»æ–‡ä»¶åŠ è½½ " << g_diaries.size() << " ç¯‡æ—¥è®°æ•°æ®" << std::endl;
    } catch (const std::exception& e) {
        std::cerr << "âŒ åŠ è½½æ—¥è®°æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸: " << e.what() << std::endl;
        // å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨
        g_diaries.clear();
    } catch (...) {
        std::cerr << "âŒ åŠ è½½æ—¥è®°æ•°æ®æ—¶å‘ç”ŸæœªçŸ¥å¼‚å¸¸" << std::endl;
        // å‘ç”ŸæœªçŸ¥å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨
        g_diaries.clear();
    }
}

// å°†æ—¥è®°æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
void Server::saveDiariesToFile() {
    try {
        // åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•
        std::filesystem::path dirPath = std::filesystem::path(DIARIES_FILE).parent_path();
        if (!std::filesystem::exists(dirPath)) {
            std::filesystem::create_directories(dirPath);
        }
        
        std::ofstream outFile(DIARIES_FILE, std::ios::trunc);
        if (!outFile.is_open()) {
            std::cerr << "âŒ æ— æ³•æ‰“å¼€æ—¥è®°æ•°æ®æ–‡ä»¶è¿›è¡Œå†™å…¥: " << DIARIES_FILE << std::endl;
            return;
        }
        
        // æ„å»ºJSONæ•°ç»„
        outFile << "[";
        
        for (size_t i = 0; i < g_diaries.size(); i++) {
            const Diary& diary = g_diaries[i];
            
            if (i > 0) {
                outFile << ",";
            }
            
            // å†™å…¥å•ä¸ªæ—¥è®°çš„JSONå¯¹è±¡
            // è½¬ä¹‰å­—ç¬¦ä¸²ä¸­çš„ç‰¹æ®Šå­—ç¬¦
            std::string escapedTitle = diary.title;
            std::string escapedContent = diary.content;
            std::string escapedAuthor = diary.author;
            
            // è½¬ä¹‰åŒå¼•å·
            size_t pos = 0;
            while ((pos = escapedTitle.find('"')) != std::string::npos) {
                escapedTitle.replace(pos, 1, "\\\"");
                pos += 2;
            }
            
            pos = 0;
            while ((pos = escapedContent.find('"')) != std::string::npos) {
                escapedContent.replace(pos, 1, "\\\"");
                pos += 2;
            }
            
            pos = 0;
            while ((pos = escapedAuthor.find('"')) != std::string::npos) {
                escapedAuthor.replace(pos, 1, "\\\"");
                pos += 2;
            }
            
            // è½¬ä¹‰æ¢è¡Œç¬¦
            pos = 0;
            while ((pos = escapedContent.find('\n')) != std::string::npos) {
                escapedContent.replace(pos, 1, "\\n");
                pos += 2;
            }
            
            pos = 0;
            while ((pos = escapedContent.find('\r')) != std::string::npos) {
                escapedContent.replace(pos, 1, "\\r");
                pos += 2;
            }
            
            outFile << "{\"id\":" << diary.id << ",\"title\":\"" << escapedTitle << "\",\"content\":\"" << escapedContent << "\",\"mood\":" << diary.mood << ",\"author\":\"" << escapedAuthor << "\",\"createdAt\":\"" << diary.createdAt << "\"}";
        }
        
        outFile << "]";
        
        // æ£€æŸ¥å†™å…¥æ˜¯å¦æˆåŠŸ
        if (outFile.fail()) {
            std::cerr << "âŒ å†™å…¥æ—¥è®°æ•°æ®æ–‡ä»¶å¤±è´¥" << std::endl;
        } else {
            std::cout << "ğŸ’¾ å·²å°† " << g_diaries.size() << " ç¯‡æ—¥è®°æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶: " << DIARIES_FILE << std::endl;
        }
        
        outFile.close();
    } catch (const std::exception& e) {
        std::cerr << "âŒ ä¿å­˜æ—¥è®°æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸: " << e.what() << std::endl;
    } catch (...) {
        std::cerr << "âŒ ä¿å­˜æ—¥è®°æ•°æ®æ—¶å‘ç”ŸæœªçŸ¥å¼‚å¸¸" << std::endl;
    }
}

// å°†æ„¿æœ›æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
void Server::saveWishesToFile() {
    try {
        // åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•
        std::filesystem::path dirPath = std::filesystem::path(WISHES_FILE).parent_path();
        if (!std::filesystem::exists(dirPath)) {
            std::filesystem::create_directories(dirPath);
        }
        
        std::ofstream outFile(WISHES_FILE, std::ios::trunc);
        if (!outFile.is_open()) {
            std::cerr << "âŒ æ— æ³•æ‰“å¼€æ„¿æœ›æ•°æ®æ–‡ä»¶è¿›è¡Œå†™å…¥: " << WISHES_FILE << std::endl;
            return;
        }
        
        // æ„å»ºJSONæ•°ç»„
        outFile << "[";
        
        for (size_t i = 0; i < g_wishes.size(); i++) {
            const Wish& wish = g_wishes[i];
            
            if (i > 0) {
                outFile << ",";
            }
            
            // å†™å…¥å•ä¸ªæ„¿æœ›çš„JSONå¯¹è±¡
        outFile << "{\"id\":" << wish.id << ",";
        outFile << "\"content\":\"" << wish.content << "\",";
        outFile << "\"title\":\"" << wish.title << "\",";
        outFile << "\"description\":\"" << wish.description << "\",";
        outFile << "\"category\":\"" << wish.category << "\",";
        outFile << "\"isCompleted\":" << (wish.isCompleted ? 1 : 0) << ",";
        outFile << "\"createdAt\":\"" << wish.createdAt << "\",";
        outFile << "\"completedAt\":\"" << wish.completedAt << "\"}";
        }
        
        outFile << "]";
        
        // æ£€æŸ¥å†™å…¥æ˜¯å¦æˆåŠŸ
        if (outFile.fail()) {
            std::cerr << "âŒ å†™å…¥æ„¿æœ›æ•°æ®æ–‡ä»¶å¤±è´¥" << std::endl;
        } else {
            std::cout << "ğŸ’¾ å·²å°† " << g_wishes.size() << " ä¸ªæ„¿æœ›æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶: " << WISHES_FILE << std::endl;
        }
        
        outFile.close();
    } catch (const std::exception& e) {
        std::cerr << "âŒ ä¿å­˜æ„¿æœ›æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸: " << e.what() << std::endl;
    } catch (...) {
        std::cerr << "âŒ ä¿å­˜æ„¿æœ›æ•°æ®æ—¶å‘ç”ŸæœªçŸ¥å¼‚å¸¸" << std::endl;
    }
}

// åˆå§‹åŒ–çºªå¿µæ—¥æ•°æ®å­˜å‚¨ç›®å½•
void Server::initializeAnniversaryStorage() {
    // åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•
    std::filesystem::path dirPath = std::filesystem::path(ANNIVERSARIES_FILE).parent_path();
    if (!std::filesystem::exists(dirPath)) {
        std::filesystem::create_directories(dirPath);
        std::cout << "ğŸ“ å·²åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•: " << dirPath << std::endl;
    }
    
    // åˆ›å»ºç©ºçš„çºªå¿µæ—¥æ•°æ®æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if (!std::filesystem::exists(ANNIVERSARIES_FILE)) {
        std::ofstream outFile(ANNIVERSARIES_FILE);
        if (outFile.is_open()) {
            outFile << "[]";
            outFile.close();
            std::cout << "ğŸ“„ å·²åˆ›å»ºçºªå¿µæ—¥æ•°æ®æ–‡ä»¶: " << ANNIVERSARIES_FILE << std::endl;
        }
    }
}

// ä»æ–‡ä»¶å®‰å…¨åŠ è½½çºªå¿µæ—¥æ•°æ®ï¼ˆä¿®å¤ç‰ˆï¼‰
void Server::safeLoadAnniversariesFromFile() {
    try {
        // åˆå§‹åŒ–å­˜å‚¨ç›®å½•
        initializeAnniversaryStorage();
        
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (!std::filesystem::exists(ANNIVERSARIES_FILE)) {
            std::cout << "ğŸ“„ çºªå¿µæ—¥æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨" << std::endl;
            return;
        }
        
        // æ‰“å¼€æ–‡ä»¶å¹¶è·å–å¤§å°ï¼Œé¿å…è¯»å–è¿‡å¤§æ–‡ä»¶
        std::ifstream inFile(ANNIVERSARIES_FILE, std::ios::ate);
        if (!inFile.is_open()) {
            std::cerr << "âŒ æ— æ³•æ‰“å¼€çºªå¿µæ—¥æ•°æ®æ–‡ä»¶: " << ANNIVERSARIES_FILE << std::endl;
            return;
        }
        
        // è·å–æ–‡ä»¶å¤§å°ï¼Œé™åˆ¶è¯»å–å¤§å°
        std::streampos fileSize = inFile.tellg();
        inFile.seekg(0, std::ios::beg);
        
        // é™åˆ¶æ–‡ä»¶å¤§å°ï¼Œé¿å…å†…å­˜æ¶ˆè€—è¿‡é«˜
        if (fileSize > 1024 * 1024) { // é™åˆ¶ä¸º1MB
            std::cerr << "âŒ çºªå¿µæ—¥æ•°æ®æ–‡ä»¶è¿‡å¤§ï¼Œé™åˆ¶è¯»å–å¤§å°" << std::endl;
            inFile.close();
            return;
        }
        
        // è¯»å–æ–‡ä»¶å†…å®¹
        std::string jsonContent;
        jsonContent.resize(static_cast<size_t>(fileSize));
        inFile.read(&jsonContent[0], fileSize);
        inFile.close();
        
        // æ¸…ç©ºå…¨å±€çºªå¿µæ—¥åˆ—è¡¨
        g_anniversaries.clear();
        
        // è§£æJSONæ•°æ® - ç®€åŒ–ç‰ˆï¼Œä½¿ç”¨æ›´å®‰å…¨çš„è§£ææ–¹å¼
        // åªå¤„ç†ç®€å•çš„JSONç»“æ„ï¼Œé¿å…å¤æ‚åµŒå¥—å¯¼è‡´çš„é—®é¢˜
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºæ•°ç»„
        if (jsonContent == "[]" || jsonContent == "") {
            std::cout << "ğŸ“„ çºªå¿µæ—¥æ•°æ®æ–‡ä»¶ä¸ºç©ºï¼Œä½¿ç”¨ç©ºåˆ—è¡¨" << std::endl;
            return;
        }
        
        // ç®€åŒ–çš„JSONè§£æï¼Œåªå¤„ç†ç®€å•çš„æƒ…å†µ
        size_t start = jsonContent.find('[');
        size_t end = jsonContent.rfind(']');
        if (start == std::string::npos || end == std::string::npos || start >= end) {
            std::cerr << "âŒ æ— æ•ˆçš„çºªå¿µæ—¥æ•°æ®æ–‡ä»¶æ ¼å¼" << std::endl;
            return;
        }
        
        // æå–æ•°ç»„å†…å®¹
        std::string arrayContent = jsonContent.substr(start + 1, end - start - 1);
        
        // åˆ†å‰²å¯¹è±¡
        size_t pos = 0;
        while (pos < arrayContent.size()) {
            // æ‰¾åˆ°å¯¹è±¡çš„å¼€å§‹å’Œç»“æŸä½ç½®
            size_t objStart = arrayContent.find('{', pos);
            if (objStart == std::string::npos) break;
            
            size_t objEnd = arrayContent.find('}', objStart + 1);
            if (objEnd == std::string::npos) break;
            
            // æå–å•ä¸ªå¯¹è±¡
            std::string objStr = arrayContent.substr(objStart, objEnd - objStart + 1);
            
            // è§£æå¯¹è±¡çš„å„ä¸ªå­—æ®µ
            Anniversary anniversary;
            
            // è§£æid - ä½¿ç”¨æ›´å¯é çš„æ–¹å¼
            size_t idPos = objStr.find("\"id\":");
            if (idPos != std::string::npos) {
                // æ‰¾åˆ°idå€¼çš„å¼€å§‹ä½ç½®ï¼ˆè·³è¿‡å†’å·å’Œå¯èƒ½çš„ç©ºæ ¼ï¼‰
                size_t idValStart = idPos + 6; // "id": ä¹‹åçš„ä½ç½®
                // è·³è¿‡å¯èƒ½çš„ç©ºæ ¼
                while (idValStart < objStr.size() && (objStr[idValStart] == ' ' || objStr[idValStart] == '\t')) {
                    idValStart++;
                }
                // æ‰¾åˆ°idå€¼çš„ç»“æŸä½ç½®ï¼ˆé€—å·æˆ–å³æ‹¬å·ï¼‰
                size_t idEnd = objStr.find(',', idValStart);
                if (idEnd == std::string::npos) {
                    idEnd = objStr.find('}', idValStart);
                }
                std::string idStr = objStr.substr(idValStart, idEnd - idValStart);
                anniversary.id = std::stoll(idStr);
            }
            
            // è§£ætitle - ä½¿ç”¨æ›´å¯é çš„æ–¹å¼
            size_t titlePos = objStr.find("\"title\":");
            if (titlePos != std::string::npos) {
                // æ‰¾åˆ°titleå€¼çš„å¼€å§‹å¼•å·ä½ç½®
                size_t titleColonPos = objStr.find(':', titlePos);
                if (titleColonPos != std::string::npos) {
                    size_t titleValStart = objStr.find('"', titleColonPos + 1);
                    if (titleValStart != std::string::npos) {
                        // æ‰¾åˆ°titleå€¼çš„ç»“æŸå¼•å·ä½ç½®
                        size_t titleValEnd = objStr.find('"', titleValStart + 1);
                        if (titleValEnd != std::string::npos) {
                            anniversary.title = objStr.substr(titleValStart + 1, titleValEnd - titleValStart - 1);
                        }
                    }
                }
            }
            
            // è§£ædate - ä½¿ç”¨æ›´å¯é çš„æ–¹å¼
            size_t datePos = objStr.find("\"date\":");
            if (datePos != std::string::npos) {
                // æ‰¾åˆ°dateå€¼çš„å¼€å§‹å¼•å·ä½ç½®
                size_t dateColonPos = objStr.find(':', datePos);
                if (dateColonPos != std::string::npos) {
                    size_t dateValStart = objStr.find('"', dateColonPos + 1);
                    if (dateValStart != std::string::npos) {
                        // æ‰¾åˆ°dateå€¼çš„ç»“æŸå¼•å·ä½ç½®
                        size_t dateValEnd = objStr.find('"', dateValStart + 1);
                        if (dateValEnd != std::string::npos) {
                            anniversary.date = objStr.substr(dateValStart + 1, dateValEnd - dateValStart - 1);
                        }
                    }
                }
            }
            
            // è§£æcategory - ä½¿ç”¨æ›´å¯é çš„æ–¹å¼
            size_t categoryPos = objStr.find("\"category\":");
            if (categoryPos != std::string::npos) {
                // æ‰¾åˆ°categoryå€¼çš„å¼€å§‹å¼•å·ä½ç½®
                size_t categoryColonPos = objStr.find(':', categoryPos);
                if (categoryColonPos != std::string::npos) {
                    size_t categoryValStart = objStr.find('"', categoryColonPos + 1);
                    if (categoryValStart != std::string::npos) {
                        // æ‰¾åˆ°categoryå€¼çš„ç»“æŸå¼•å·ä½ç½®
                        size_t categoryValEnd = objStr.find('"', categoryValStart + 1);
                        if (categoryValEnd != std::string::npos) {
                            anniversary.category = objStr.substr(categoryValStart + 1, categoryValEnd - categoryValStart - 1);
                        }
                    }
                }
            }
            
            // è§£æcreatedAt - ä½¿ç”¨æ›´å¯é çš„æ–¹å¼
            size_t createdAtPos = objStr.find("\"createdAt\":");
            if (createdAtPos != std::string::npos) {
                // æ‰¾åˆ°createdAtå€¼çš„å¼€å§‹å¼•å·ä½ç½®
                size_t createdAtColonPos = objStr.find(':', createdAtPos);
                if (createdAtColonPos != std::string::npos) {
                    size_t createdAtValStart = objStr.find('"', createdAtColonPos + 1);
                    if (createdAtValStart != std::string::npos) {
                        // æ‰¾åˆ°createdAtå€¼çš„ç»“æŸå¼•å·ä½ç½®
                        size_t createdAtValEnd = objStr.find('"', createdAtValStart + 1);
                        if (createdAtValEnd != std::string::npos) {
                            anniversary.createdAt = objStr.substr(createdAtValStart + 1, createdAtValEnd - createdAtValStart - 1);
                        }
                    }
                }
            }
            
            // æ·»åŠ åˆ°å…¨å±€åˆ—è¡¨
            g_anniversaries.push_back(anniversary);
            
            // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¯¹è±¡
            pos = objEnd + 2; // è·³è¿‡é€—å·å’Œç©ºæ ¼
        }
        
        std::cout << "ğŸ“¥ å·²ä»æ–‡ä»¶åŠ è½½ " << g_anniversaries.size() << " ä¸ªçºªå¿µæ—¥æ•°æ®" << std::endl;
    } catch (const std::exception& e) {
        std::cerr << "âŒ åŠ è½½çºªå¿µæ—¥æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸: " << e.what() << std::endl;
        // å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨
        g_anniversaries.clear();
    } catch (...) {
        std::cerr << "âŒ åŠ è½½çºªå¿µæ—¥æ•°æ®æ—¶å‘ç”ŸæœªçŸ¥å¼‚å¸¸" << std::endl;
        // å‘ç”ŸæœªçŸ¥å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨
        g_anniversaries.clear();
    }
}

// å°†çºªå¿µæ—¥æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
void Server::saveAnniversariesToFile() {
    std::ofstream outFile(ANNIVERSARIES_FILE, std::ios::trunc);
    if (!outFile.is_open()) {
        std::cerr << "âŒ æ— æ³•æ‰“å¼€çºªå¿µæ—¥æ•°æ®æ–‡ä»¶è¿›è¡Œå†™å…¥: " << ANNIVERSARIES_FILE << std::endl;
        return;
    }
    
    // æ„å»ºJSONæ•°ç»„ - ä½¿ç”¨æ­£ç¡®çš„æ ¼å¼
    outFile << "[";
    
    for (size_t i = 0; i < g_anniversaries.size(); i++) {
        const Anniversary& a = g_anniversaries[i];
        
        if (i > 0) {
            outFile << ",";
        }
        
        // å†™å…¥å•ä¸ªçºªå¿µæ—¥çš„JSONå¯¹è±¡
        outFile << "{\"id\":" << a.id << ",";
        outFile << "\"title\":\"" << a.title << "\",";
        outFile << "\"date\":\"" << a.date << "\",";
        outFile << "\"category\":\"" << a.category << "\",";
        outFile << "\"createdAt\":\"" << a.createdAt << "\"}";
    }
    
    outFile << "]";
    
    // æ£€æŸ¥å†™å…¥æ˜¯å¦æˆåŠŸ
    if (outFile.fail()) {
        std::cerr << "âŒ å†™å…¥çºªå¿µæ—¥æ•°æ®æ–‡ä»¶å¤±è´¥" << std::endl;
    } else {
        std::cout << "ğŸ’¾ å·²å°† " << g_anniversaries.size() << " ä¸ªçºªå¿µæ—¥æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶: " << ANNIVERSARIES_FILE << std::endl;
    }
    
    outFile.close();
}

// è¿”å›ç…§ç‰‡åˆ—è¡¨
std::string Server::handleGetPhotosRequest() {
    // æ‰«æimagesç›®å½•ï¼Œè¿”å›æ‰€æœ‰ç…§ç‰‡
    std::string imagesDir = getProjectRoot() + "/frontend/images";
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    response += "{\"success\": true,\"message\": \"è·å–ç…§ç‰‡åˆ—è¡¨æˆåŠŸ\",\"data\": {\"photos\": [";

    // éå†imagesç›®å½•ï¼Œè·å–æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶
    try {
        // å­˜å‚¨å›¾ç‰‡æ–‡ä»¶å’Œå®ƒä»¬çš„æœ€åä¿®æ”¹æ—¶é—´
        std::vector<std::pair<std::filesystem::path, std::filesystem::file_time_type>> imageFiles;
        
        // é¦–å…ˆæ”¶é›†æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶
        for (const auto& entry : std::filesystem::directory_iterator(imagesDir)) {
            if (entry.is_regular_file()) {
                std::string fileName = entry.path().filename().string();
                // åªå¤„ç†å›¾ç‰‡æ–‡ä»¶
                std::string ext = fileName.substr(fileName.find_last_of(".") + 1);
                for (char& c : ext) {
                    c = tolower(c);
                }
                if (ext == "jpg" || ext == "jpeg" || ext == "png" || ext == "gif") {
                    // è·å–æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´
                    auto lastWriteTime = std::filesystem::last_write_time(entry.path());
                    imageFiles.emplace_back(entry.path(), lastWriteTime);
                }
            }
        }
        
        // æŒ‰æœ€åä¿®æ”¹æ—¶é—´å€’åºæ’åºï¼Œæœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶æ’åœ¨å‰é¢
        std::sort(imageFiles.begin(), imageFiles.end(), [](const auto& a, const auto& b) {
            return a.second > b.second;
        });
        
        bool first = true;
        for (const auto& [filePath, lastWriteTime] : imageFiles) {
            std::string fileName = filePath.filename().string();
            if (!first) {
                response += ",";
            }
            
            // è·å–æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´ï¼Œæ ¼å¼åŒ–ä¸ºYYYY-MM-DD
            std::string uploadDate = "2025-12-14";
            try {
                // å°†file_time_typeè½¬æ¢ä¸ºtime_t
                auto tp = std::chrono::time_point_cast<std::chrono::system_clock::duration>(
                    lastWriteTime - std::filesystem::file_time_type::clock::now() + std::chrono::system_clock::now());
                auto now_c = std::chrono::system_clock::to_time_t(tp);
                std::tm* ptm = std::localtime(&now_c);
                char dateStr[20];
                std::strftime(dateStr, sizeof(dateStr), "%Y-%m-%d", ptm);
                uploadDate = std::string(dateStr);
            } catch (...) {
                // å¦‚æœè·å–æ—¶é—´å¤±è´¥ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸä½œä¸ºé»˜è®¤å€¼
                auto now = std::chrono::system_clock::now();
                auto now_c = std::chrono::system_clock::to_time_t(now);
                std::tm* ptm = std::localtime(&now_c);
                char dateStr[20];
                std::strftime(dateStr, sizeof(dateStr), "%Y-%m-%d", ptm);
                uploadDate = std::string(dateStr);
            }
            
            // ä½¿ç”¨æ–‡ä»¶å¤§å°å’Œæ—¶é—´æˆ³ç”Ÿæˆå”¯ä¸€IDï¼Œé¿å…å“ˆå¸Œå†²çª
            auto fileSize = std::filesystem::file_size(filePath);
            long long timestamp = std::chrono::duration_cast<std::chrono::milliseconds>(
                std::chrono::system_clock::now().time_since_epoch()).count();
            long long photoId = (timestamp << 32) | (fileSize & 0xFFFFFFFF);
            
            response += "{\"id\": " + std::to_string(photoId) + ",";
            response += "\"url\": \"/frontend/images/" + fileName + "\",";
            response += "\"name\": \"" + fileName + "\",";
            response += "\"category\": \"æ—¥å¸¸\",";
            response += "\"uploadDate\": \"" + uploadDate + "\"}";
            first = false;
        }
    } catch (const std::filesystem::filesystem_error& e) {
        std::cerr << "âŒ æ— æ³•è¯»å–imagesç›®å½•: " << e.what() << std::endl;
    } catch (const std::exception& e) {
        std::cerr << "âŒ å¤„ç†ç…§ç‰‡åˆ—è¡¨æ—¶å‘ç”Ÿå¼‚å¸¸: " << e.what() << std::endl;
    }

    response += "]}}";
    return response;
}

// è¿”å›çºªå¿µæ—¥åˆ—è¡¨
std::string Server::handleGetAnniversariesRequest() {
    // æ„å»ºJSONå“åº”
    std::string jsonStr = "{\"success\": true,\"message\": \"è·å–çºªå¿µæ—¥åˆ—è¡¨æˆåŠŸ\",\"data\": {\"anniversaries\": [";
    
    // æ·»åŠ æ‰€æœ‰çºªå¿µæ—¥
    for (size_t i = 0; i < g_anniversaries.size(); i++) {
        const Anniversary& a = g_anniversaries[i];
        jsonStr += "{\"id\":" + std::to_string(a.id) + ",\"title\":\"" + a.title + "\",\"date\":\"" + a.date + "\",\"category\":\"" + a.category + "\",\"createdAt\":\"" + a.createdAt + "\"}";
        
        if (i < g_anniversaries.size() - 1) {
            jsonStr += ",";
        }
    }
    
    jsonStr += "]}}";
    
    // è¿”å›å“åº”
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    response += jsonStr;
    return response;
}

// å¤„ç†æ·»åŠ çºªå¿µæ—¥è¯·æ±‚
std::string Server::handlePostAnniversariesRequest(const std::string& body) {
    // è§£æè¯·æ±‚ä½“ï¼Œè·å–çºªå¿µæ—¥æ•°æ®
    std::string title = ""; // é»˜è®¤æ ‡é¢˜
    std::string date = ""; // é»˜è®¤æ—¥æœŸ
    std::string category = "æ‹çˆ±"; // é»˜è®¤åˆ†ç±»
    
    // æ”¹è¿›çš„JSONè§£æï¼Œå¤„ç†å„ç§æ ¼å¼æƒ…å†µ
    try {
        // è§£ææ ‡é¢˜ - æ›´å¥å£®çš„è§£ææ–¹æ³•
        size_t titlePos = body.find("\"title\":");
        if (titlePos != std::string::npos) {
            // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
            size_t afterColon = body.find(":", titlePos) + 1;
            // è·³è¿‡ç©ºæ ¼
            size_t titleValueStart = body.find_first_not_of(" \t\r\n", afterColon);
            
            if (titleValueStart != std::string::npos && body[titleValueStart] == '"') {
                // è·³è¿‡å¼€å¤´å¼•å·
                titleValueStart++;
                // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰æƒ…å†µ
                size_t titleValueEnd = titleValueStart;
                bool inEscape = false;
                while (titleValueEnd < body.size()) {
                    if (body[titleValueEnd] == '\\') {
                        inEscape = !inEscape;
                    } else if (body[titleValueEnd] == '"' && !inEscape) {
                        break;
                    } else {
                        inEscape = false;
                    }
                    titleValueEnd++;
                }
                title = body.substr(titleValueStart, titleValueEnd - titleValueStart);
            }
        }
        
        // è§£ææ—¥æœŸ - æ›´å¥å£®çš„è§£ææ–¹æ³•
        size_t datePos = body.find("\"date\":");
        if (datePos != std::string::npos) {
            // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
            size_t afterColon = body.find(":", datePos) + 1;
            // è·³è¿‡ç©ºæ ¼
            size_t dateValueStart = body.find_first_not_of(" \t\r\n", afterColon);
            
            if (dateValueStart != std::string::npos && body[dateValueStart] == '"') {
                // è·³è¿‡å¼€å¤´å¼•å·
                dateValueStart++;
                // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰æƒ…å†µ
                size_t dateValueEnd = dateValueStart;
                bool inEscape = false;
                while (dateValueEnd < body.size()) {
                    if (body[dateValueEnd] == '\\') {
                        inEscape = !inEscape;
                    } else if (body[dateValueEnd] == '"' && !inEscape) {
                        break;
                    } else {
                        inEscape = false;
                    }
                    dateValueEnd++;
                }
                date = body.substr(dateValueStart, dateValueEnd - dateValueStart);
            }
        }
        
        // è§£æåˆ†ç±» - æ›´å¥å£®çš„è§£ææ–¹æ³•
        size_t categoryPos = body.find("\"category\":");
        if (categoryPos != std::string::npos) {
            // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
            size_t afterColon = body.find(":", categoryPos) + 1;
            // è·³è¿‡ç©ºæ ¼
            size_t categoryValueStart = body.find_first_not_of(" \t\r\n", afterColon);
            
            if (categoryValueStart != std::string::npos && body[categoryValueStart] == '"') {
                // è·³è¿‡å¼€å¤´å¼•å·
                categoryValueStart++;
                // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰æƒ…å†µ
                size_t categoryValueEnd = categoryValueStart;
                bool inEscape = false;
                while (categoryValueEnd < body.size()) {
                    if (body[categoryValueEnd] == '\\') {
                        inEscape = !inEscape;
                    } else if (body[categoryValueEnd] == '"' && !inEscape) {
                        break;
                    } else {
                        inEscape = false;
                    }
                    categoryValueEnd++;
                }
                category = body.substr(categoryValueStart, categoryValueEnd - categoryValueStart);
            }
        }
    } catch (...) {
        std::cerr << "âŒ è§£æçºªå¿µæ—¥è¯·æ±‚ä½“æ—¶å‘ç”Ÿå¼‚å¸¸" << std::endl;
    }
    
    // éªŒè¯è§£æç»“æœï¼Œç¡®ä¿æ•°æ®æœ‰æ•ˆ
    if (title.empty()) {
        title = "æœªå‘½åçºªå¿µæ—¥";
    }
    if (date.empty()) {
        date = "2025-01-01";
    }
    if (category.empty()) {
        category = "æ‹çˆ±";  
    }
    
    // ç”Ÿæˆå½“å‰æ—¶é—´ä½œä¸ºcreatedAt
    auto now = std::chrono::system_clock::now();
    auto now_c = std::chrono::system_clock::to_time_t(now);
    std::stringstream createdAtStream;
    createdAtStream << std::put_time(std::localtime(&now_c), "%Y-%m-%dT%H:%M:%S");
    std::string createdAt = createdAtStream.str();
    
    // åˆ›å»ºæ–°çš„çºªå¿µæ—¥å¯¹è±¡
    Anniversary newAnniversary;
    newAnniversary.id = static_cast<int>(std::time(nullptr));
    newAnniversary.title = title;
    newAnniversary.date = date;
    newAnniversary.category = category;
    newAnniversary.createdAt = createdAt;
    
    // æ·»åŠ åˆ°å…¨å±€çºªå¿µæ—¥åˆ—è¡¨
    g_anniversaries.push_back(newAnniversary);
    
    // å°†æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
    saveAnniversariesToFile();
    
    // æ‰“å°æ—¥å¿—
    std::cout << "ğŸ“… æ·»åŠ äº†æ–°çºªå¿µæ—¥: " << newAnniversary.title << "ï¼Œæ—¥æœŸ: " << newAnniversary.date << std::endl;
    
    // è¿”å›æˆåŠŸå“åº”
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    response += "{\"success\": true,\"message\": \"çºªå¿µæ—¥æ·»åŠ æˆåŠŸ\",\"data\": {\"anniversaryId\": " + std::to_string(newAnniversary.id) + ",\"title\": \"" + newAnniversary.title + "\",\"date\": \"" + newAnniversary.date + "\",\"category\": \"" + newAnniversary.category + "\",\"createdAt\": \"" + newAnniversary.createdAt + "\"}}";
    return response;
}

// å¤„ç†åˆ é™¤çºªå¿µæ—¥è¯·æ±‚
std::string Server::handleDeleteAnniversariesRequest(const std::string& body) {
    // è§£æè¯·æ±‚ä½“ï¼Œè·å–çºªå¿µæ—¥ID
    std::string idStr = "";
    size_t idPos = body.find("\"id\":");
    if (idPos != std::string::npos) {
        // æ‰¾åˆ°idå­—æ®µçš„å€¼å¼€å§‹ä½ç½®ï¼Œè·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
        size_t idValueStart = body.find(":", idPos) + 1;
        idValueStart = body.find_first_not_of(" \t\r\n", idValueStart);
        
        if (idValueStart != std::string::npos) {
            // æ£€æŸ¥å€¼æ˜¯å¦è¢«å¼•å·åŒ…å›´
            if (body[idValueStart] == '"') {
                // å­—ç¬¦ä¸²ç±»å‹çš„IDï¼Œæ‰¾åˆ°ç»“å°¾å¼•å·
                idValueStart++;
                size_t idEnd = body.find('"', idValueStart);
                if (idEnd != std::string::npos) {
                    idStr = body.substr(idValueStart, idEnd - idValueStart);
                }
            } else {
                // æ•°å­—ç±»å‹çš„IDï¼Œæ‰¾åˆ°å€¼çš„ç»“å°¾
                size_t idEnd = body.find_first_of(",}", idValueStart);
                if (idEnd != std::string::npos) {
                    idStr = body.substr(idValueStart, idEnd - idValueStart);
                } else {
                    // IDæ˜¯è¯·æ±‚ä½“çš„æœ€åä¸€éƒ¨åˆ†
                    idStr = body.substr(idValueStart);
                }
            }
        }
    }
    
    // è½¬æ¢IDä¸ºé•¿æ•´æ•°
    long long anniversaryId = 0;
    if (!idStr.empty()) {
        anniversaryId = std::stoll(idStr);
    }
    
    // æŸ¥æ‰¾å¹¶åˆ é™¤çºªå¿µæ—¥
    bool deleted = false;
    for (auto it = g_anniversaries.begin(); it != g_anniversaries.end();) {
        if (it->id == anniversaryId) {
            // æ‰“å°æ—¥å¿—
            std::cout << "ğŸ—‘ï¸ åˆ é™¤äº†çºªå¿µæ—¥: " << it->title << "ï¼ŒID: " << it->id << std::endl;
            
            // ä»åˆ—è¡¨ä¸­åˆ é™¤
            it = g_anniversaries.erase(it);
            deleted = true;
        } else {
            ++it;
        }
    }
    
    // å°†æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
    saveAnniversariesToFile();
    
    // è¿”å›å“åº”
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    
    if (deleted) {
        response += "{\"success\": true,\"message\": \"çºªå¿µæ—¥åˆ é™¤æˆåŠŸ\"}";
    } else {
        response += "{\"success\": false,\"message\": \"çºªå¿µæ—¥åˆ é™¤å¤±è´¥ï¼Œæœªæ‰¾åˆ°è¯¥çºªå¿µæ—¥\"}";
    }
    
    return response;
}

// è¿”å›æ—¥è®°åˆ—è¡¨
std::string Server::handleGetDiariesRequest() {
    // æ„å»ºJSONå“åº”
    std::string jsonStr = "{\"success\": true,\"message\": \"è·å–æ—¥è®°åˆ—è¡¨æˆåŠŸ\",\"data\": {\"diaries\": [";
    
    // æ·»åŠ æ‰€æœ‰æ—¥è®°
    for (size_t i = 0; i < g_diaries.size(); i++) {
        const Diary& diary = g_diaries[i];
        
        if (i > 0) {
            jsonStr += ",";
        }
        
        // æ·»åŠ æ‰€æœ‰å­—æ®µ
        // å…ˆåˆ›å»ºå„ä¸ªå­—æ®µçš„è½¬ä¹‰ç‰ˆæœ¬
        auto escapeJsonString = [](const std::string& str) {
            std::string result;
            for (char c : str) {
                switch (c) {
                    case '"':
                        result += "\\\"";
                        break;
                    case '\\':
                        result += "\\\\";
                        break;
                    case '\n':
                        result += "\\n";
                        break;
                    case '\r':
                        result += "\\r";
                        break;
                    case '\t':
                        result += "\\t";
                        break;
                    default:
                        result += c;
                }
            }
            return result;
        };
        
        std::string escapedTitle = escapeJsonString(diary.title);
        std::string escapedContent = escapeJsonString(diary.content);
        std::string escapedAuthor = escapeJsonString(diary.author);
        
        // æ„å»ºæ­£ç¡®çš„JSONå­—ç¬¦ä¸²
        jsonStr += "{\"id\":" + std::to_string(diary.id) + ",\"title\":\"" + escapedTitle + "\",\"content\":\"" + escapedContent + "\",\"mood\":" + std::to_string(diary.mood) + ",\"author\":\"" + escapedAuthor + "\",\"createdAt\":\"" + diary.createdAt + "\"}";
    }
    
    jsonStr += "]}}";
    
    // è¿”å›å“åº”
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    response += jsonStr;
    return response;
}

// å¤„ç†æ·»åŠ æ—¥è®°è¯·æ±‚
std::string Server::handlePostDiariesRequest(const std::string& body) {
    // è§£æè¯·æ±‚ä½“ï¼Œè·å–æ—¥è®°æ•°æ®
    std::string title = ""; // é»˜è®¤æ ‡é¢˜
    std::string content = ""; // é»˜è®¤å†…å®¹
    int mood = 3; // é»˜è®¤å¿ƒæƒ…å€¼
    std::string author = "æœªçŸ¥ä½œè€…"; // é»˜è®¤ä½œè€…
    
    // è§£æè¯·æ±‚ä½“ï¼Œè·å–æ—¥è®°æ•°æ®
    try {
        // æ‰“å°å®Œæ•´çš„è¯·æ±‚ä½“ï¼Œç”¨äºè°ƒè¯•
        std::cout << "ğŸ“¨ æ”¶åˆ°çš„æ—¥è®°è¯·æ±‚ä½“: " << body << std::endl;
        
        // è§£ætitleå­—æ®µ
        size_t titlePos = body.find("\"title\":");
        std::cout << "ğŸ” æŸ¥æ‰¾titleå­—æ®µï¼Œä½ç½®: " << titlePos << std::endl;
        
        if (titlePos != std::string::npos) {
            // æ‰¾åˆ°titleå­—æ®µçš„å†’å·ï¼Œå…è®¸å­—æ®µåå’Œå†’å·ä¹‹é—´æœ‰ç©ºæ ¼
            size_t colonPos = body.find(":", titlePos);
            std::cout << "ğŸ” æŸ¥æ‰¾titleå†’å·ï¼Œä½ç½®: " << colonPos << std::endl;
            
            if (colonPos != std::string::npos) {
                // è·³è¿‡å†’å·å’Œå¯èƒ½çš„ç©ºæ ¼
                size_t afterColon = colonPos + 1;
                while (afterColon < body.size() && (body[afterColon] == ' ' || body[afterColon] == '\t' || body[afterColon] == '\n' || body[afterColon] == '\r')) {
                    afterColon++;
                }
                std::cout << "ğŸ” è·³è¿‡ç©ºæ ¼åï¼Œtitleå€¼å¼€å§‹ä½ç½®: " << afterColon << std::endl;
                
                // æ‰¾åˆ°titleå­—æ®µå€¼çš„å¼€å§‹å¼•å·
                size_t titleValStart = body.find('"', afterColon);
                std::cout << "ğŸ” æŸ¥æ‰¾titleå€¼å¼€å§‹å¼•å·ï¼Œä½ç½®: " << titleValStart << std::endl;
                
                if (titleValStart != std::string::npos) {
                    titleValStart++;
                    
                    // æ”¹è¿›çš„titleå­—æ®µè§£æï¼Œå¤„ç†è½¬ä¹‰å­—ç¬¦
                    size_t titleValEnd = titleValStart;
                    bool inEscape = false;
                    
                    // éå†æ•´ä¸ªbodyï¼Œç›´åˆ°æ‰¾åˆ°åŒ¹é…çš„ç»“æŸå¼•å·
                    while (titleValEnd < body.size()) {
                        char currentChar = body[titleValEnd];
                        
                        if (currentChar == '\\') {
                            // å¤„ç†è½¬ä¹‰å­—ç¬¦
                            inEscape = !inEscape;
                            titleValEnd++;
                        } else if (currentChar == '"' && !inEscape) {
                            // æ‰¾åˆ°æœªè½¬ä¹‰çš„ç»“æŸå¼•å·ï¼Œè§£æå®Œæˆ
                            break;
                        } else {
                            // æ™®é€šå­—ç¬¦æˆ–è½¬ä¹‰çŠ¶æ€ä¸‹çš„å¼•å·
                            inEscape = false;
                            titleValEnd++;
                        }
                    }
                    
                    // ç¡®ä¿æ‰¾åˆ°äº†ç»“æŸå¼•å·
                    if (titleValEnd < body.size()) {
                        title = body.substr(titleValStart, titleValEnd - titleValStart);
                        std::cout << "ğŸ“ è§£æåˆ°æ—¥è®°æ ‡é¢˜: " << title << std::endl;
                    } else {
                        std::cerr << "âš ï¸  æœªæ‰¾åˆ°titleå­—æ®µçš„ç»“æŸå¼•å·" << std::endl;
                    }
                }
            }
        }
        
        // è§£æcontentå­—æ®µ
        size_t contentPos = body.find("\"content\":");
        std::cout << "ğŸ” æŸ¥æ‰¾contentå­—æ®µï¼Œä½ç½®: " << contentPos << std::endl;
        
        if (contentPos != std::string::npos) {
            // æ‰¾åˆ°contentå­—æ®µçš„å†’å·ï¼Œå…è®¸å­—æ®µåå’Œå†’å·ä¹‹é—´æœ‰ç©ºæ ¼
            size_t colonPos = body.find(":", contentPos);
            std::cout << "ğŸ” æŸ¥æ‰¾contentå†’å·ï¼Œä½ç½®: " << colonPos << std::endl;
            
            if (colonPos != std::string::npos) {
                // è·³è¿‡å†’å·å’Œå¯èƒ½çš„ç©ºæ ¼
                size_t afterColon = colonPos + 1;
                while (afterColon < body.size() && (body[afterColon] == ' ' || body[afterColon] == '\t' || body[afterColon] == '\n' || body[afterColon] == '\r')) {
                    afterColon++;
                }
                std::cout << "ğŸ” è·³è¿‡ç©ºæ ¼åï¼Œcontentå€¼å¼€å§‹ä½ç½®: " << afterColon << std::endl;
                
                // æ‰¾åˆ°contentå­—æ®µå€¼çš„å¼€å§‹å¼•å·
                size_t contentValStart = body.find('"', afterColon);
                std::cout << "ğŸ” æŸ¥æ‰¾contentå€¼å¼€å§‹å¼•å·ï¼Œä½ç½®: " << contentValStart << std::endl;
                
                if (contentValStart != std::string::npos) {
                    contentValStart++;
                    
                    // æ”¹è¿›çš„contentå­—æ®µè§£æï¼Œå¤„ç†æ¢è¡Œç¬¦å’Œè½¬ä¹‰å­—ç¬¦
                    size_t contentValEnd = contentValStart;
                    bool inEscape = false;
                    
                    // éå†æ•´ä¸ªbodyï¼Œç›´åˆ°æ‰¾åˆ°åŒ¹é…çš„ç»“æŸå¼•å·
                    while (contentValEnd < body.size()) {
                        char currentChar = body[contentValEnd];
                        
                        if (currentChar == '\\') {
                            // å¤„ç†è½¬ä¹‰å­—ç¬¦
                            inEscape = !inEscape;
                            contentValEnd++;
                        } else if (currentChar == '"' && !inEscape) {
                            // æ‰¾åˆ°æœªè½¬ä¹‰çš„ç»“æŸå¼•å·ï¼Œè§£æå®Œæˆ
                            break;
                        } else {
                            // æ™®é€šå­—ç¬¦æˆ–è½¬ä¹‰çŠ¶æ€ä¸‹çš„å¼•å·
                            inEscape = false;
                            contentValEnd++;
                        }
                    }
                    
                    // ç¡®ä¿æ‰¾åˆ°äº†ç»“æŸå¼•å·
                    if (contentValEnd < body.size()) {
                        content = body.substr(contentValStart, contentValEnd - contentValStart);
                        std::cout << "ğŸ“ è§£æåˆ°æ—¥è®°å†…å®¹: " << (content.size() > 50 ? content.substr(0, 50) + "..." : content) << std::endl;
                    } else {
                        std::cerr << "âš ï¸  æœªæ‰¾åˆ°contentå­—æ®µçš„ç»“æŸå¼•å·" << std::endl;
                    }
                }
            }
        }
        
        // è§£æå®Œæˆåï¼Œæ‰“å°æ‰€æœ‰å­—æ®µå€¼
        std::cout << "ğŸ“Š è§£æå®Œæˆåçš„å€¼: " << std::endl;
        std::cout << "   title: '" << title << "'" << std::endl;
        std::cout << "   content: '" << (content.size() > 100 ? content.substr(0, 100) + "..." : content) << "'" << std::endl;
        std::cout << "   mood: " << mood << std::endl;
        std::cout << "   author: '" << author << "'" << std::endl;
        
        // è§£æmoodå­—æ®µ
        size_t moodPos = body.find("\"mood\":");
        if (moodPos != std::string::npos) {
            size_t colonPos = body.find(":", moodPos);
            if (colonPos != std::string::npos) {
                size_t moodValStart = body.find_first_of("0123456789", colonPos + 1);
                if (moodValStart != std::string::npos) {
                    size_t moodValEnd = body.find_first_not_of("0123456789", moodValStart);
                    std::string moodStr = body.substr(moodValStart, moodValEnd - moodValStart);
                    try {
                        mood = std::stoi(moodStr);
                    } catch (...) {
                        mood = 3; // é»˜è®¤å¿ƒæƒ…å€¼
                    }
                }
            }
        }
        
        // è§£æauthorå­—æ®µ
        size_t authorPos = body.find("\"author\":");
        std::cout << "ğŸ” æŸ¥æ‰¾authorå­—æ®µï¼Œä½ç½®: " << authorPos << std::endl;
        
        if (authorPos != std::string::npos) {
            // æ‰¾åˆ°authorå­—æ®µçš„å†’å·ï¼Œå…è®¸å­—æ®µåå’Œå†’å·ä¹‹é—´æœ‰ç©ºæ ¼
            size_t colonPos = body.find(":", authorPos);
            std::cout << "ğŸ” æŸ¥æ‰¾authorå†’å·ï¼Œä½ç½®: " << colonPos << std::endl;
            
            if (colonPos != std::string::npos) {
                // è·³è¿‡å†’å·å’Œå¯èƒ½çš„ç©ºæ ¼
                size_t afterColon = colonPos + 1;
                while (afterColon < body.size() && (body[afterColon] == ' ' || body[afterColon] == '\t' || body[afterColon] == '\n' || body[afterColon] == '\r')) {
                    afterColon++;
                }
                std::cout << "ğŸ” è·³è¿‡ç©ºæ ¼åï¼Œauthorå€¼å¼€å§‹ä½ç½®: " << afterColon << std::endl;
                
                // æ‰¾åˆ°authorå­—æ®µå€¼çš„å¼€å§‹å¼•å·
                size_t authorValStart = body.find('"', afterColon);
                std::cout << "ğŸ” æŸ¥æ‰¾authorå€¼å¼€å§‹å¼•å·ï¼Œä½ç½®: " << authorValStart << std::endl;
                
                if (authorValStart != std::string::npos) {
                    authorValStart++;
                    
                    // æ”¹è¿›çš„authorå­—æ®µè§£æï¼Œå¤„ç†è½¬ä¹‰å­—ç¬¦
                    size_t authorValEnd = authorValStart;
                    bool inEscape = false;
                    
                    // éå†æ•´ä¸ªbodyï¼Œç›´åˆ°æ‰¾åˆ°åŒ¹é…çš„ç»“æŸå¼•å·
                    while (authorValEnd < body.size()) {
                        char currentChar = body[authorValEnd];
                        
                        if (currentChar == '\\') {
                            // å¤„ç†è½¬ä¹‰å­—ç¬¦
                            inEscape = !inEscape;
                            authorValEnd++;
                        } else if (currentChar == '"' && !inEscape) {
                            // æ‰¾åˆ°æœªè½¬ä¹‰çš„ç»“æŸå¼•å·ï¼Œè§£æå®Œæˆ
                            break;
                        } else {
                            // æ™®é€šå­—ç¬¦æˆ–è½¬ä¹‰çŠ¶æ€ä¸‹çš„å¼•å·
                            inEscape = false;
                            authorValEnd++;
                        }
                    }
                    
                    // ç¡®ä¿æ‰¾åˆ°äº†ç»“æŸå¼•å·
                    if (authorValEnd < body.size()) {
                        author = body.substr(authorValStart, authorValEnd - authorValStart);
                        std::cout << "ğŸ“ è§£æåˆ°æ—¥è®°ä½œè€…: " << author << std::endl;
                    } else {
                        std::cerr << "âš ï¸  æœªæ‰¾åˆ°authorå­—æ®µçš„ç»“æŸå¼•å·ï¼Œä½¿ç”¨é»˜è®¤ä½œè€…" << std::endl;
                        author = "æœªçŸ¥ä½œè€…"; // ç¡®ä¿ä½œè€…å­—æ®µä¸ä¸ºç©º
                    }
                }
            }
        }
    } catch (...) {
        std::cerr << "âŒ è§£ææ—¥è®°è¯·æ±‚ä½“æ—¶å‘ç”Ÿå¼‚å¸¸" << std::endl;
    }
    
    // ç”Ÿæˆå½“å‰æ—¶é—´ä½œä¸ºcreatedAt
    auto now = std::chrono::system_clock::now();
    auto now_c = std::chrono::system_clock::to_time_t(now);
    std::stringstream createdAtStream;
    createdAtStream << std::put_time(std::localtime(&now_c), "%Y-%m-%dT%H:%M:%S");
    std::string createdAt = createdAtStream.str();
    
    // åˆ›å»ºæ–°çš„æ—¥è®°å¯¹è±¡
    Diary newDiary;
    newDiary.id = static_cast<long long>(std::time(nullptr));
    newDiary.title = title;
    newDiary.content = content;
    newDiary.mood = mood;
    newDiary.author = author;
    newDiary.createdAt = createdAt;
    
    // éªŒè¯æ—¥è®°æ˜¯å¦æœ‰æ•ˆï¼šæ ‡é¢˜æˆ–å†…å®¹è‡³å°‘æœ‰ä¸€ä¸ªä¸ä¸ºç©º
    if (!newDiary.title.empty() || !newDiary.content.empty()) {
        // æ·»åŠ åˆ°å…¨å±€æ—¥è®°åˆ—è¡¨
        g_diaries.push_back(newDiary);
    } else {
        std::cerr << "âš ï¸  æ‹’ç»æ·»åŠ æ— æ•ˆæ—¥è®°ï¼šæ ‡é¢˜å’Œå†…å®¹éƒ½ä¸ºç©º" << std::endl;
        // è¿”å›é”™è¯¯å“åº”
        std::string response = "HTTP/1.1 400 Bad Request\r\n";
        response += "Content-Type: application/json; charset=UTF-8\r\n";
        response += "Access-Control-Allow-Origin: *\r\n";
        response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
        response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
        response += "Connection: keep-alive\r\n";
        response += "\r\n";
        response += "{\"success\": false,\"message\": \"æ—¥è®°æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º\"}";
        return response;
    }
    
    // å°†æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
    saveDiariesToFile();
    
    // æ‰“å°æ—¥å¿—
    std::cout << "ğŸ“ æ·»åŠ äº†æ–°æ—¥è®°: " << newDiary.title << ", ä½œè€…: " << newDiary.author << std::endl;
    
    // è¿”å›æˆåŠŸå“åº”
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    response += "{\"success\": true,\"message\": \"æ—¥è®°æ·»åŠ æˆåŠŸ\",\"data\": {\"diaryId\": " + std::to_string(newDiary.id) + ",\"title\": \"" + newDiary.title + "\",\"content\": \"" + newDiary.content + "\",\"mood\": " + std::to_string(newDiary.mood) + ",\"author\": \"" + newDiary.author + "\",\"createdAt\": \"" + newDiary.createdAt + "\"}}";
    return response;
}

// å¤„ç†åˆ é™¤æ—¥è®°è¯·æ±‚
std::string Server::handleDeleteDiariesRequest(const std::string& body) {
    // è§£æè¯·æ±‚ä½“ï¼Œè·å–æ—¥è®°ID
    std::string idStr = "";
    size_t idPos = body.find("\"id\":");
    if (idPos != std::string::npos) {
        // æ‰¾åˆ°idå­—æ®µçš„å€¼å¼€å§‹ä½ç½®ï¼Œè·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
        size_t idValueStart = body.find(":", idPos) + 1;
        idValueStart = body.find_first_not_of(" \t\r\n", idValueStart);
        
        if (idValueStart != std::string::npos) {
            // æ£€æŸ¥å€¼æ˜¯å¦è¢«å¼•å·åŒ…å›´
            if (body[idValueStart] == '"') {
                // å­—ç¬¦ä¸²ç±»å‹çš„IDï¼Œæ‰¾åˆ°ç»“å°¾å¼•å·
                idValueStart++;
                size_t idEnd = body.find('"', idValueStart);
                if (idEnd != std::string::npos) {
                    idStr = body.substr(idValueStart, idEnd - idValueStart);
                }
            } else {
                // æ•°å­—ç±»å‹çš„IDï¼Œæ‰¾åˆ°å€¼çš„ç»“å°¾
                size_t idEnd = body.find_first_of(",}", idValueStart);
                idStr = body.substr(idValueStart, idEnd - idValueStart);
            }
        }
    }
    
    // è½¬æ¢IDä¸ºé•¿æ•´æ•°
    long long diaryId = 0;
    if (!idStr.empty()) {
        try {
            diaryId = std::stoll(idStr);
        } catch (...) {
            std::cerr << "âŒ æ—¥è®°IDè§£æå¤±è´¥: " << idStr << std::endl;
        }
    }
    
    // æŸ¥æ‰¾å¹¶åˆ é™¤æ—¥è®°
    bool deleted = false;
    std::string diaryTitle = "æœªçŸ¥æ—¥è®°";
    for (auto it = g_diaries.begin(); it != g_diaries.end();) {
        if (it->id == diaryId) {
            diaryTitle = it->title;
            
            // æ‰“å°æ—¥å¿—
            std::cout << "ğŸ—‘ï¸ åˆ é™¤äº†æ—¥è®°: " << it->title << "ï¼ŒID: " << it->id << std::endl;
            
            // ä»åˆ—è¡¨ä¸­åˆ é™¤
            it = g_diaries.erase(it);
            deleted = true;
        } else {
            ++it;
        }
    }
    
    // å°†æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
    saveDiariesToFile();
    
    // è¿”å›å“åº”
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    
    if (deleted) {
        response += "{\"success\": true,\"message\": \"æ—¥è®°åˆ é™¤æˆåŠŸ\"}";
    } else {
        response += "{\"success\": false,\"message\": \"æ—¥è®°åˆ é™¤å¤±è´¥ï¼Œæœªæ‰¾åˆ°è¯¥æ—¥è®°\"}";
    }
    
    return response;
}

// è¿”å›æ„¿æœ›åˆ—è¡¨
std::string Server::handleGetWishesRequest() {
    // æ„å»ºJSONå“åº”
    std::string jsonStr = "{\"success\": true,\"message\": \"è·å–æ„¿æœ›åˆ—è¡¨æˆåŠŸ\",\"data\": {\"wishes\": [";
    
    // æ·»åŠ æ‰€æœ‰æ„¿æœ›
    for (size_t i = 0; i < g_wishes.size(); i++) {
        const Wish& wish = g_wishes[i];
        // æ·»åŠ titleå­—æ®µï¼Œä¸contentå­—æ®µå€¼ç›¸åŒï¼Œé€‚é…å‰ç«¯éœ€æ±‚
        jsonStr += "{\"id\":" + std::to_string(wish.id) + ",\"title\":\"" + wish.title + "\",\"content\":\"" + wish.content + "\",\"description\":\"" + wish.description + "\",\"category\":\"" + wish.category + "\",\"isCompleted\":" + (wish.isCompleted ? "1" : "0") + ",\"createdAt\":\"" + wish.createdAt + "\",\"completedAt\":\"" + wish.completedAt + "\"}";
        
        if (i < g_wishes.size() - 1) {
            jsonStr += ",";
        }
    }
    
    jsonStr += "]}}";
    
    // è¿”å›å“åº”
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    response += jsonStr;
    return response;
}

// å¤„ç†æ·»åŠ æ„¿æœ›è¯·æ±‚
std::string Server::handlePostWishesRequest(const std::string& body) {
    // è§£æè¯·æ±‚ä½“ï¼Œè·å–æ„¿æœ›å†…å®¹
    std::string content = "";
    std::string title = "";
    std::string description = "";
    std::string category = "å…¶ä»–";
    
    // æ”¹è¿›çš„JSONè§£æï¼Œå¤„ç†å„ç§æ ¼å¼æƒ…å†µ
    try {
        // è§£ætitleå­—æ®µ
        size_t titlePos = body.find("\"title\":");
        if (titlePos != std::string::npos) {
            size_t colonPos = body.find(":", titlePos);
            if (colonPos != std::string::npos) {
                size_t titleStart = body.find_first_not_of(" \t\r\n", colonPos + 1);
                if (titleStart != std::string::npos && body[titleStart] == '"') {
                    titleStart++;
                    size_t titleEnd = titleStart;
                    bool inEscape = false;
                    while (titleEnd < body.size()) {
                        if (body[titleEnd] == '\\') {
                            inEscape = !inEscape;
                        } else if (body[titleEnd] == '"' && !inEscape) {
                            break;
                        } else {
                            inEscape = false;
                        }
                        titleEnd++;
                    }
                    if (titleEnd != std::string::npos) {
                        title = body.substr(titleStart, titleEnd - titleStart);
                    }
                }
            }
        }
        
        // è§£æcontentå­—æ®µ
        size_t contentPos = body.find("\"content\":");
        if (contentPos != std::string::npos) {
            size_t colonPos = body.find(":", contentPos);
            if (colonPos != std::string::npos) {
                size_t contentStart = body.find_first_not_of(" \t\r\n", colonPos + 1);
                if (contentStart != std::string::npos && body[contentStart] == '"') {
                    contentStart++;
                    size_t contentEnd = contentStart;
                    bool inEscape = false;
                    while (contentEnd < body.size()) {
                        if (body[contentEnd] == '\\') {
                            inEscape = !inEscape;
                        } else if (body[contentEnd] == '"' && !inEscape) {
                            break;
                        } else {
                            inEscape = false;
                        }
                        contentEnd++;
                    }
                    if (contentEnd != std::string::npos) {
                        content = body.substr(contentStart, contentEnd - contentStart);
                    }
                }
            }
        }
        
        // è§£ædescriptionå­—æ®µ
        size_t descriptionPos = body.find("\"description\":");
        if (descriptionPos != std::string::npos) {
            size_t colonPos = body.find(":", descriptionPos);
            if (colonPos != std::string::npos) {
                size_t descriptionStart = body.find_first_not_of(" \t\r\n", colonPos + 1);
                if (descriptionStart != std::string::npos && body[descriptionStart] == '"') {
                    descriptionStart++;
                    size_t descriptionEnd = descriptionStart;
                    bool inEscape = false;
                    while (descriptionEnd < body.size()) {
                        if (body[descriptionEnd] == '\\') {
                            inEscape = !inEscape;
                        } else if (body[descriptionEnd] == '"' && !inEscape) {
                            break;
                        } else {
                            inEscape = false;
                        }
                        descriptionEnd++;
                    }
                    if (descriptionEnd != std::string::npos) {
                        description = body.substr(descriptionStart, descriptionEnd - descriptionStart);
                    }
                }
            }
        }
        
        // è§£æcategoryå­—æ®µ
        size_t categoryPos = body.find("\"category\":");
        if (categoryPos != std::string::npos) {
            size_t colonPos = body.find(":", categoryPos);
            if (colonPos != std::string::npos) {
                size_t categoryStart = body.find_first_not_of(" \t\r\n", colonPos + 1);
                if (categoryStart != std::string::npos && body[categoryStart] == '"') {
                    categoryStart++;
                    size_t categoryEnd = categoryStart;
                    bool inEscape = false;
                    while (categoryEnd < body.size()) {
                        if (body[categoryEnd] == '\\') {
                            inEscape = !inEscape;
                        } else if (body[categoryEnd] == '"' && !inEscape) {
                            break;
                        } else {
                            inEscape = false;
                        }
                        categoryEnd++;
                    }
                    if (categoryEnd != std::string::npos) {
                        category = body.substr(categoryStart, categoryEnd - categoryStart);
                    }
                }
            }
        }
    } catch (...) {
        std::cerr << "âŒ è§£ææ„¿æœ›è¯·æ±‚ä½“æ—¶å‘ç”Ÿå¼‚å¸¸" << std::endl;
    }
    
    // éªŒè¯è§£æç»“æœï¼Œç¡®ä¿å†…å®¹æœ‰æ•ˆ
    if (content.empty() || content == ",") {
        if (title.empty()) {
            title = "æœªå‘½åæ„¿æœ›";
        }
        content = title;
    }
    
    if (title.empty()) {
        title = content;
    }
    
    // ç”Ÿæˆå½“å‰æ—¶é—´ä½œä¸ºcreatedAt
    auto now = std::chrono::system_clock::now();
    auto now_c = std::chrono::system_clock::to_time_t(now);
    std::stringstream createdAtStream;
    createdAtStream << std::put_time(std::localtime(&now_c), "%Y-%m-%dT%H:%M:%S");
    std::string createdAt = createdAtStream.str();
    
    // åˆ›å»ºæ–°çš„æ„¿æœ›å¯¹è±¡
    Wish newWish;
    newWish.id = static_cast<long long>(std::time(nullptr));
    newWish.content = content;
    newWish.title = title;
    newWish.description = description;
    newWish.category = category;
    newWish.isCompleted = false;
    newWish.createdAt = createdAt;
    newWish.completedAt = "";
    
    // æ·»åŠ åˆ°å…¨å±€æ„¿æœ›åˆ—è¡¨
    g_wishes.push_back(newWish);
    
    // å°†æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
    saveWishesToFile();
    
    // æ‰“å°æ—¥å¿—
    std::cout << "âœ¨ æ·»åŠ äº†æ–°æ„¿æœ›: " << newWish.content << std::endl;
    
    // è¿”å›æˆåŠŸå“åº”
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    response += "{\"success\": true,\"message\": \"æ„¿æœ›æ·»åŠ æˆåŠŸ\",\"data\": {\"wishId\": " + std::to_string(newWish.id) + ",\"content\": \"" + newWish.content + "\",\"isCompleted\": 0,\"createdAt\": \"" + newWish.createdAt + "\"}}";
    return response;
}

// å¤„ç†å®Œæˆæ„¿æœ›è¯·æ±‚
std::string Server::handleCompleteWishRequest(const std::string& body) {
    // è§£æè¯·æ±‚ä½“ï¼Œè·å–æ„¿æœ›ID
    std::string idStr = "";
    size_t idPos = body.find("\"id\":");
    if (idPos != std::string::npos) {
        // æ‰¾åˆ°idå­—æ®µçš„å€¼å¼€å§‹ä½ç½®ï¼Œè·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
        size_t idValueStart = body.find(":", idPos) + 1;
        idValueStart = body.find_first_not_of(" \t\r\n", idValueStart);
        
        // æ£€æŸ¥å€¼æ˜¯å¦è¢«å¼•å·åŒ…å›´
        if (idValueStart != std::string::npos) {
            if (body[idValueStart] == '"') {
                // å­—ç¬¦ä¸²ç±»å‹çš„IDï¼Œæ‰¾åˆ°ç»“å°¾å¼•å·
                idValueStart++;
                size_t idEnd = body.find("\"", idValueStart);
                if (idEnd != std::string::npos) {
                    idStr = body.substr(idValueStart, idEnd - idValueStart);
                }
            } else {
                // æ•°å­—ç±»å‹çš„IDï¼Œæ‰¾åˆ°å€¼çš„ç»“å°¾
                size_t idEnd = body.find_first_of(",}", idValueStart);
                if (idEnd != std::string::npos) {
                    idStr = body.substr(idValueStart, idEnd - idValueStart);
                } else {
                    idStr = body.substr(idValueStart);
                }
            }
        }
    }
    
    // è§£æisCompletedå‚æ•°
    bool isCompleted = true; // é»˜è®¤æ ‡è®°ä¸ºå®Œæˆ
    size_t completedPos = body.find("\"isCompleted\":");
    if (completedPos != std::string::npos) {
        // æ‰¾åˆ°isCompletedå­—æ®µçš„å€¼å¼€å§‹ä½ç½®ï¼Œè·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
        size_t completedValueStart = body.find(":", completedPos) + 1;
        completedValueStart = body.find_first_not_of(" \t\r\n", completedValueStart);
        
        // æ£€æŸ¥å€¼æ˜¯å¦è¢«å¼•å·åŒ…å›´
        if (completedValueStart != std::string::npos) {
            if (body[completedValueStart] == '"') {
                // å­—ç¬¦ä¸²ç±»å‹çš„å€¼ï¼Œæ‰¾åˆ°ç»“å°¾å¼•å·
                completedValueStart++;
                size_t completedEnd = body.find("\"", completedValueStart);
                if (completedEnd != std::string::npos) {
                    std::string completedStr = body.substr(completedValueStart, completedEnd - completedValueStart);
                    isCompleted = (completedStr == "1" || completedStr == "true");
                }
            } else {
                // æ•°å­—ç±»å‹çš„å€¼ï¼Œæ‰¾åˆ°å€¼çš„ç»“å°¾
                size_t completedEnd = body.find_first_of(",}", completedValueStart);
                std::string completedStr = body.substr(completedValueStart, completedEnd - completedValueStart);
                isCompleted = (completedStr == "1" || completedStr == "true");
            }
        }
    }
    
    // è½¬æ¢IDä¸ºé•¿æ•´æ•°
    long long wishId = 0;
    if (!idStr.empty()) {
        wishId = std::stoll(idStr);
    }
    
    // æŸ¥æ‰¾å¹¶æ›´æ–°æ„¿æœ›
    bool found = false;
    std::string wishContent;
    for (auto& wish : g_wishes) {
        if (wish.id == wishId) {
            // æ›´æ–°å®ŒæˆçŠ¶æ€
            wish.isCompleted = isCompleted;
            
            if (isCompleted) {
                // ç”Ÿæˆå½“å‰æ—¶é—´ä½œä¸ºcompletedAt
                auto now = std::chrono::system_clock::now();
                auto now_c = std::chrono::system_clock::to_time_t(now);
                std::stringstream completedAtStream;
                completedAtStream << std::put_time(std::localtime(&now_c), "%Y-%m-%dT%H:%M:%S");
                wish.completedAt = completedAtStream.str();
                
                // æ‰“å°æ—¥å¿—
                std::cout << "ğŸ‰ å®Œæˆäº†æ„¿æœ›: " << wish.content << "ï¼ŒID: " << wish.id << std::endl;
            } else {
                // æ¸…ç©ºå®Œæˆæ—¶é—´
                wish.completedAt = "";
                
                // æ‰“å°æ—¥å¿—
                std::cout << "ğŸ”„ å–æ¶ˆå®Œæˆæ„¿æœ›: " << wish.content << "ï¼ŒID: " << wish.id << std::endl;
            }
            
            wishContent = wish.content;
            found = true;
            break;
        }
    }
    
    // å°†æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
    saveWishesToFile();
    
    // è¿”å›å“åº”
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    
    if (found) {
        // ä½¿ç”¨std::stringæ¥æ„å»ºå“åº”ï¼Œé¿å…ç›´æ¥æ‹¼æ¥const char*å’Œconst char[]
        std::string message = isCompleted ? "æ„¿æœ›æ ‡è®°ä¸ºå®ŒæˆæˆåŠŸ" : "æ„¿æœ›å–æ¶ˆå®ŒæˆæˆåŠŸ";
        response += "{\"success\": true,\"message\": \"" + message + "\"}";
    } else {
        response += "{\"success\": false,\"message\": \"æœªæ‰¾åˆ°è¯¥æ„¿æœ›\"}";
    }
    
    return response;
}

// å¤„ç†åˆ é™¤æ„¿æœ›è¯·æ±‚
std::string Server::handleDeleteWishesRequest(const std::string& body) {
    // è§£æè¯·æ±‚ä½“ï¼Œè·å–æ„¿æœ›ID
    std::string idStr = "";
    size_t idPos = body.find("\"id\":");
    if (idPos != std::string::npos) {
        // æ‰¾åˆ°idå­—æ®µçš„å€¼å¼€å§‹ä½ç½®ï¼Œè·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
        size_t idValueStart = body.find(":", idPos) + 1;
        idValueStart = body.find_first_not_of(" \t\r\n", idValueStart);
        
        // æ£€æŸ¥å€¼æ˜¯å¦è¢«å¼•å·åŒ…å›´
        if (idValueStart != std::string::npos) {
            if (body[idValueStart] == '"') {
                // å­—ç¬¦ä¸²ç±»å‹çš„IDï¼Œæ‰¾åˆ°ç»“å°¾å¼•å·
                idValueStart++;
                size_t idEnd = body.find("\"", idValueStart);
                if (idEnd != std::string::npos) {
                    idStr = body.substr(idValueStart, idEnd - idValueStart);
                }
            } else {
                // æ•°å­—ç±»å‹çš„IDï¼Œæ‰¾åˆ°å€¼çš„ç»“å°¾
                size_t idEnd = body.find_first_of(",}", idValueStart);
                if (idEnd != std::string::npos) {
                    idStr = body.substr(idValueStart, idEnd - idValueStart);
                } else {
                    idStr = body.substr(idValueStart);
                }
            }
        }
    }
    
    // è½¬æ¢IDä¸ºé•¿æ•´æ•°
    long long wishId = 0;
    if (!idStr.empty()) {
        wishId = std::stoll(idStr);
    }
    
    // æŸ¥æ‰¾å¹¶åˆ é™¤æ„¿æœ›
    bool deleted = false;
    std::string wishContent = "";
    for (auto it = g_wishes.begin(); it != g_wishes.end();) {
        if (it->id == wishId) {
            // ä¿å­˜æ„¿æœ›å†…å®¹ç”¨äºæ—¥å¿—
            wishContent = it->content;
            
            // æ‰“å°æ—¥å¿—
            std::cout << "ğŸ—‘ï¸ åˆ é™¤äº†æ„¿æœ›: " << wishContent << "ï¼ŒID: " << it->id << std::endl;
            
            // ä»åˆ—è¡¨ä¸­åˆ é™¤
            it = g_wishes.erase(it);
            deleted = true;
        } else {
            ++it;
        }
    }
    
    // å°†æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
    saveWishesToFile();
    
    // è¿”å›å“åº”
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    
    if (deleted) {
        response += "{\"success\": true,\"message\": \"æ„¿æœ›åˆ é™¤æˆåŠŸ\"}";
    } else {
        response += "{\"success\": false,\"message\": \"æ„¿æœ›åˆ é™¤å¤±è´¥ï¼Œæœªæ‰¾åˆ°è¯¥æ„¿æœ›\"}";
    }
    
    return response;
}

// ä»¥ä¸‹æ˜¯server.hä¸­å£°æ˜ä½†å®é™…æœªä½¿ç”¨çš„å‡½æ•°ï¼Œæ·»åŠ ç©ºå®ç°ä»¥é¿å…é“¾æ¥é”™è¯¯

// è®¾ç½®è·¯ç”±
void Server::setupRoutes() {
    // ç©ºå®ç°
}

// å¤„ç†ç™»å½•è¯·æ±‚
void Server::handleLogin(const std::string& body, std::string& response) {
    // ç©ºå®ç°
}

// å¤„ç†ç…§ç‰‡ä¸Šä¼ ï¼ˆæ—§ç‰ˆï¼‰
void Server::handlePhotoUpload(const std::string& body, std::string& response) {
    // ç©ºå®ç°
}

// å¤„ç†ç…§ç‰‡åˆ é™¤ï¼ˆæ—§ç‰ˆï¼‰
void Server::handlePhotoDelete(const std::string& body, std::string& response) {
    // ç©ºå®ç°
}

// å¤„ç†ç…§ç‰‡åˆ—è¡¨ï¼ˆæ—§ç‰ˆï¼‰
void Server::handlePhotoList(const std::string& body, std::string& response) {
    // ç©ºå®ç°
}

// å¤„ç†æ·»åŠ çºªå¿µæ—¥ï¼ˆæ—§ç‰ˆï¼‰
void Server::handleAnniversaryAdd(const std::string& body, std::string& response) {
    // ç©ºå®ç°
}

// å¤„ç†çºªå¿µæ—¥åˆ—è¡¨ï¼ˆæ—§ç‰ˆï¼‰
void Server::handleAnniversaryList(const std::string& body, std::string& response) {
    // ç©ºå®ç°
}

// å¤„ç†æ·»åŠ æ—¥è®°ï¼ˆæ—§ç‰ˆï¼‰
void Server::handleDiaryAdd(const std::string& body, std::string& response) {
    // ç©ºå®ç°
}

// å¤„ç†æ—¥è®°åˆ—è¡¨ï¼ˆæ—§ç‰ˆï¼‰
void Server::handleDiaryList(const std::string& body, std::string& response) {
    // ç©ºå®ç°
}

// å¤„ç†ç»Ÿè®¡æ•°æ®ï¼ˆæ—§ç‰ˆï¼‰
void Server::handleStats(const std::string& body, std::string& response) {
    // ç©ºå®ç°
}

// å¤„ç†ç™»å½•è¯·æ±‚ï¼ˆæ–°ç‰ˆï¼‰
std::string Server::handleLoginRequest(const std::string& body) {
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    response += "{\"success\": true,\"message\": \"ç™»å½•æˆåŠŸ\"}";
    return response;
}

// å¤„ç†æ‹çˆ±å¤©æ•°è¯·æ±‚
std::string Server::handleLoveDaysRequest() {
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    response += "{\"success\": true,\"message\": \"è·å–æ‹çˆ±å¤©æ•°æˆåŠŸ\",\"data\": {\"days\": 100}}";
    return response;
}

// æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä»¥æŒ‡å®šåç¼€ç»“å°¾
bool Server::endsWith(const std::string& str, const std::string& suffix) {
    if (suffix.size() > str.size()) {
        return false;
    }
    return str.compare(str.size() - suffix.size(), suffix.size(), suffix) == 0;
}

// è¿”å›æ´»åŠ¨åˆ—è¡¨
std::string Server::handleGetActivitiesRequest() {
    // è¿”å›æ´»åŠ¨åˆ—è¡¨ï¼ˆä½¿ç”¨å…¨å±€æ´»åŠ¨åˆ—è¡¨ä¸­çš„æ•°æ®ï¼‰
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    
    // æ„å»ºJSONå“åº”
    std::string jsonStr = "{\"success\": true,\"message\": \"è·å–æ´»åŠ¨åˆ—è¡¨æˆåŠŸ\",\"data\": {\"activities\": [";
    
    for (size_t i = 0; i < g_activities.size(); i++) {
        const Activity& a = g_activities[i];
        jsonStr += "{\"id\":" + std::to_string(a.id) + ",\"type\":\"" + a.type + "\",\"content\":\"" + a.content + "\",\"createdAt\":\"" + a.createdAt + "\",\"operator\":\"" + a.operator_ + "\"}";
        
        if (i < g_activities.size() - 1) {
            jsonStr += ",";
        }
    }
    
    jsonStr += "]}}";
    
    response += jsonStr;
    return response;
}

// å¤„ç†æ·»åŠ æ´»åŠ¨è¯·æ±‚
std::string Server::handlePostActivitiesRequest(const std::string& body) {
    // è§£æè¯·æ±‚ä½“ï¼Œè·å–æ´»åŠ¨æ•°æ®
    std::string type = "other"; // é»˜è®¤ç±»å‹
    std::string content = "";
    std::string createdAt = "";
    std::string operator_ = "";
    long long id = std::time(nullptr);
    
    std::cout << "ğŸ“¨ æ”¶åˆ°æ´»åŠ¨è¯·æ±‚ä½“: " << body << std::endl;
    
    // æ”¹è¿›çš„JSONè§£æï¼Œå¤„ç†å„ç§æ ¼å¼æƒ…å†µ
    try {
        // ç®€åŒ–çš„JSONè§£æï¼Œç›´æ¥æŸ¥æ‰¾å…³é”®å­—æ®µå€¼
        // è§£ætypeå­—æ®µ
        size_t typePos = body.find("\"type\":");
        if (typePos != std::string::npos) {
            // æ‰¾åˆ°":"çš„ä½ç½®
            size_t colonPos = body.find(":", typePos);
            if (colonPos != std::string::npos) {
                // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
                size_t typeStart = body.find_first_not_of(" \t\r\n", colonPos + 1);
                if (typeStart != std::string::npos && body[typeStart] == '"') {
                    // è·³è¿‡å¼€å¤´å¼•å·
                    typeStart++;
                    // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰å¼•å·çš„æƒ…å†µ
                    size_t typeEnd = typeStart;
                    bool inEscape = false;
                    while (typeEnd < body.size()) {
                        if (body[typeEnd] == '\\') {
                            inEscape = !inEscape;
                        } else if (body[typeEnd] == '"' && !inEscape) {
                            break;
                        } else {
                            inEscape = false;
                        }
                        typeEnd++;
                    }
                    if (typeEnd != std::string::npos) {
                        type = body.substr(typeStart, typeEnd - typeStart);
                    }
                }
            }
        }
        
        // è§£æcontentå­—æ®µ
        size_t contentPos = body.find("\"content\":");
        if (contentPos != std::string::npos) {
            // æ‰¾åˆ°":"çš„ä½ç½®
            size_t colonPos = body.find(":", contentPos);
            if (colonPos != std::string::npos) {
                // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
                size_t contentStart = body.find_first_not_of(" \t\r\n", colonPos + 1);
                if (contentStart != std::string::npos && body[contentStart] == '"') {
                    // è·³è¿‡å¼€å¤´å¼•å·
                    contentStart++;
                    // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰å¼•å·çš„æƒ…å†µ
                    size_t contentEnd = contentStart;
                    bool inEscape = false;
                    while (contentEnd < body.size()) {
                        if (body[contentEnd] == '\\') {
                            inEscape = !inEscape;
                        } else if (body[contentEnd] == '"' && !inEscape) {
                            break;
                        } else {
                            inEscape = false;
                        }
                        contentEnd++;
                    }
                    if (contentEnd != std::string::npos) {
                        content = body.substr(contentStart, contentEnd - contentStart);
                    }
                }
            }
        }
        
        // è§£æcreatedAtå­—æ®µ
        size_t createdAtPos = body.find("\"createdAt\":");
        if (createdAtPos != std::string::npos) {
            // æ‰¾åˆ°":"çš„ä½ç½®
            size_t colonPos = body.find(":", createdAtPos);
            if (colonPos != std::string::npos) {
                // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
                size_t createdAtStart = body.find_first_not_of(" \t\r\n", colonPos + 1);
                if (createdAtStart != std::string::npos && body[createdAtStart] == '"') {
                    // è·³è¿‡å¼€å¤´å¼•å·
                    createdAtStart++;
                    // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰å¼•å·çš„æƒ…å†µ
                    size_t createdAtEnd = createdAtStart;
                    bool inEscape = false;
                    while (createdAtEnd < body.size()) {
                        if (body[createdAtEnd] == '\\') {
                            inEscape = !inEscape;
                        } else if (body[createdAtEnd] == '"' && !inEscape) {
                            break;
                        } else {
                            inEscape = false;
                        }
                        createdAtEnd++;
                    }
                    if (createdAtEnd != std::string::npos) {
                        createdAt = body.substr(createdAtStart, createdAtEnd - createdAtStart);
                    }
                }
            }
        }
        
        // è§£æoperatorå­—æ®µ
        size_t operatorPos = body.find("\"operator\":");
        if (operatorPos != std::string::npos) {
            // æ‰¾åˆ°":"çš„ä½ç½®
            size_t colonPos = body.find(":", operatorPos);
            if (colonPos != std::string::npos) {
                // è·³è¿‡":"å’Œå¯èƒ½çš„ç©ºæ ¼
                size_t operatorStart = body.find_first_not_of(" \t\r\n", colonPos + 1);
                if (operatorStart != std::string::npos && body[operatorStart] == '"') {
                    // è·³è¿‡å¼€å¤´å¼•å·
                    operatorStart++;
                    // æ‰¾åˆ°ç»“å°¾å¼•å·ï¼Œå¤„ç†è½¬ä¹‰å¼•å·çš„æƒ…å†µ
                    size_t operatorEnd = operatorStart;
                    bool inEscape = false;
                    while (operatorEnd < body.size()) {
                        if (body[operatorEnd] == '\\') {
                            inEscape = !inEscape;
                        } else if (body[operatorEnd] == '"' && !inEscape) {
                            break;
                        } else {
                            inEscape = false;
                        }
                        operatorEnd++;
                    }
                    if (operatorEnd != std::string::npos) {
                        operator_ = body.substr(operatorStart, operatorEnd - operatorStart);
                    }
                }
            }
        }
        
        // è§£æidå­—æ®µ
        size_t idStart = body.find("\"id\":");
        if (idStart != std::string::npos) {
            idStart = body.find_first_of("0123456789", idStart + 6); // æ‰¾åˆ°idå€¼çš„å¼€å§‹
            if (idStart != std::string::npos) {
                size_t idEnd = body.find_first_not_of("0123456789", idStart); // æ‰¾åˆ°idå€¼çš„ç»“æŸ
                if (idEnd != std::string::npos) {
                    std::string idStr = body.substr(idStart, idEnd - idStart);
                    id = std::stoll(idStr);
                }
            }
        }
    } catch (...) {
        std::cerr << "âŒ è§£ææ´»åŠ¨è¯·æ±‚ä½“æ—¶å‘ç”Ÿå¼‚å¸¸" << std::endl;
    }
    
    // éªŒè¯è§£æç»“æœï¼Œç¡®ä¿ç±»å‹å’Œå†…å®¹æœ‰æ•ˆ
    if (type.empty() || type == ",") {
        type = "other";
    }
    
    // å¦‚æœæ²¡æœ‰æä¾›åˆ›å»ºæ—¶é—´ï¼Œç”Ÿæˆå½“å‰æ—¶é—´
    if (createdAt.empty()) {
        auto now = std::chrono::system_clock::now();
        auto now_c = std::chrono::system_clock::to_time_t(now);
        std::stringstream createdAtStream;
        createdAtStream << std::put_time(std::localtime(&now_c), "%Y-%m-%dT%H:%M:%S");
        createdAt = createdAtStream.str();
    }
    
    // ç¡®ä¿å†…å®¹æœ‰æ•ˆ
    if (content.empty() || content == ",") {
        // åªæœ‰åœ¨contentç¡®å®ä¸ºç©ºæˆ–æ— æ•ˆæ—¶æ‰è¿›è¡Œæ›¿æ¢
        content = "æœªçŸ¥æ´»åŠ¨";
    }
    
    // åˆ›å»ºæ–°çš„æ´»åŠ¨å¯¹è±¡
    Activity newActivity;
    newActivity.id = id; // ä½¿ç”¨å‰ç«¯ä¼ é€’çš„IDæˆ–ç”Ÿæˆçš„å”¯ä¸€ID
    newActivity.type = type;
    newActivity.content = content;
    newActivity.createdAt = createdAt;
    // å¦‚æœæ“ä½œè€…ä¸ºç©ºï¼Œé»˜è®¤ä½¿ç”¨"æœªçŸ¥ç”¨æˆ·"
    newActivity.operator_ = operator_.empty() ? "æœªçŸ¥ç”¨æˆ·" : operator_;
    
    // åªæœ‰æœ‰æ•ˆçš„æ´»åŠ¨æ‰æ·»åŠ åˆ°å…¨å±€åˆ—è¡¨ä¸­
    // éªŒè¯æ´»åŠ¨æ˜¯å¦æœ‰æ•ˆï¼š
    // 1. æ‰€æœ‰å­—æ®µä¸èƒ½ä¸ºç©º
    // 2. ä¸èƒ½åŒ…å«æ— æ•ˆå­—ç¬¦ï¼ˆå¦‚é€—å·ã€å³æ‹¬å·ç­‰ï¼‰
    // 3. createdAtå¿…é¡»æ˜¯æœ‰æ•ˆçš„æ—¶é—´æ ¼å¼ï¼ˆè‡³å°‘åŒ…å«"-"å’Œ"T"ï¼‰
    if (!newActivity.content.empty() && !newActivity.type.empty() && !newActivity.createdAt.empty() &&
        newActivity.content != "," && newActivity.content != "\"" && newActivity.content != "}" &&
        newActivity.type != "," && newActivity.type != "\"" && newActivity.type != "}" &&
        newActivity.createdAt.find("-") != std::string::npos && newActivity.createdAt.find("T") != std::string::npos) {
        // æ·»åŠ åˆ°å…¨å±€æ´»åŠ¨åˆ—è¡¨çš„å¼€å¤´ï¼Œç¡®ä¿æœ€æ–°çš„æ´»åŠ¨åœ¨å‰é¢
        g_activities.insert(g_activities.begin(), newActivity);
        
        // é™åˆ¶æ´»åŠ¨åˆ—è¡¨æ•°é‡ï¼Œåªä¿ç•™æœ€è¿‘çš„50ä¸ªæ´»åŠ¨
        if (g_activities.size() > 50) {
            g_activities.pop_back();
        }
        
        std::cout << "âœ… å·²æ·»åŠ æœ‰æ•ˆæ´»åŠ¨: " << newActivity.content << "ï¼Œç±»å‹: " << newActivity.type << "ï¼Œæ“ä½œè€…: " << newActivity.operator_ << std::endl;
    } else {
        std::cerr << "âŒ æ‹’ç»æ·»åŠ æ— æ•ˆæ´»åŠ¨: content='" << newActivity.content << "', type='" << newActivity.type << "', createdAt='" << newActivity.createdAt << "', operator='" << newActivity.operator_ << "'" << std::endl;
    }
    
    // å°†æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
    saveActivitiesToFile();
    
    // æ‰“å°æ—¥å¿—
    std::cout << "ğŸ“ æ·»åŠ äº†æ–°æ´»åŠ¨: " << newActivity.content << "ï¼Œç±»å‹: " << newActivity.type << "ï¼Œæ“ä½œè€…: " << newActivity.operator_ << "ï¼ŒID: " << newActivity.id << std::endl;
    
    // è¿”å›æˆåŠŸå“åº”
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    response += "{\"success\": true,\"message\": \"æ´»åŠ¨æ·»åŠ æˆåŠŸ\",\"data\": {\"activityId\": " + std::to_string(newActivity.id) + ",\"type\": \"" + newActivity.type + "\",\"content\": \"" + newActivity.content + "\",\"createdAt\": \"" + newActivity.createdAt + "\",\"operator\": \"" + newActivity.operator_ + "\"}}";
    return response;
}

// è¿”å›ç»Ÿè®¡æ•°æ®
std::string Server::handleGetStatsRequest() {
    // è·å–çœŸå®ç»Ÿè®¡æ•°æ®
    int totalPhotosCount = 0;
    int dailyPhotoCount = 0; // æ—¥å¸¸ç…§æ•°é‡
    int diariesCount = 0;
    int anniversariesCount = 0;
    int wishesCount = 0;
    int activitiesCount = 0;
    
    // ç»Ÿè®¡ç…§ç‰‡æ•°é‡å’Œåˆ†ç±»
    std::string photosDir = getProjectRoot() + "/frontend/images";
    if (std::filesystem::exists(photosDir) && std::filesystem::is_directory(photosDir)) {
        for (const auto& entry : std::filesystem::directory_iterator(photosDir)) {
            if (entry.is_regular_file()) {
                std::string ext = entry.path().extension().string();
                for (char& c : ext) {
                    c = tolower(c);
                }
                if (ext == ".jpg" || ext == ".jpeg" || ext == ".png" || ext == ".gif") {
                    totalPhotosCount++;
                    dailyPhotoCount++; // æ‰€æœ‰ç…§ç‰‡éƒ½ä½œä¸ºæ—¥å¸¸ç…§ç»Ÿè®¡
                }
            }
        }
    }
    
    // ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡è·å–æ—¥è®°æ•°é‡
    diariesCount = g_diaries.size();
    
    // è®¡ç®—å¹³å‡å¿ƒæƒ…æŒ‡æ•°
    double averageMood = 0.0;
    if (g_diaries.size() > 0) {
        int totalMood = 0;
        for (const auto& diary : g_diaries) {
            totalMood += diary.mood;
        }
        averageMood = static_cast<double>(totalMood) / g_diaries.size();
    }
    
    // ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡è·å–çºªå¿µæ—¥æ•°é‡
    anniversariesCount = g_anniversaries.size();
    
    // ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡è·å–æ´»åŠ¨æ•°é‡
    activitiesCount = g_activities.size();
    
    // ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡è·å–æ„¿æœ›æ•°é‡
    wishesCount = g_wishes.size();
    std::cout << "ğŸ“Š å½“å‰g_wisheså¤§å°: " << g_wishes.size() << std::endl;
    
    std::string response = "HTTP/1.1 200 OK\r\n";
    response += "Content-Type: application/json; charset=UTF-8\r\n";
    response += "Access-Control-Allow-Origin: *\r\n";
    response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
    response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
    response += "Connection: keep-alive\r\n";
    response += "\r\n";
    
    response += "{\"success\": true,\"message\": \"è·å–ç»Ÿè®¡æ•°æ®æˆåŠŸ\",\"data\": {";
    response += "\"photosCount\": " + std::to_string(totalPhotosCount) + ",";
    response += "\"dailyPhotoCount\": " + std::to_string(dailyPhotoCount) + ",";
    response += "\"diariesCount\": " + std::to_string(diariesCount) + ",";
    response += "\"anniversariesCount\": " + std::to_string(anniversariesCount) + ",";
    response += "\"wishesCount\": " + std::to_string(wishesCount) + ",";
    response += "\"activitiesCount\": " + std::to_string(activitiesCount) + ",";
    response += "\"averageMood\": " + std::to_string(averageMood);
    response += "}}";
    
    return response;
}

// æä¾›é™æ€æ–‡ä»¶æœåŠ¡
std::string Server::serveStaticFile(const std::string& filePath) {
    std::cout << "ğŸ“‚ å°è¯•æ‰“å¼€é™æ€æ–‡ä»¶: " << filePath << std::endl;

    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    std::filesystem::path path(filePath);
    
    // å¦‚æœæ˜¯ç›®å½•ï¼Œè¿”å›404
    if (std::filesystem::is_directory(path)) {
        std::cerr << "âŒ æ— æ³•æ‰“å¼€ç›®å½•ä½œä¸ºæ–‡ä»¶: " << filePath << std::endl;
        std::string response = "HTTP/1.1 404 Not Found\r\n";
        response += "Content-Type: text/html; charset=UTF-8\r\n";
        response += "Access-Control-Allow-Origin: *\r\n";
        response += "Connection: close\r\n";
        response += "\r\n";
        response += "<!DOCTYPE html><html><body><h1>404 Not Found</h1><p>ç›®å½•æ— æ³•ç›´æ¥è®¿é—®</p></body></html>";
        return response;
    }
    
    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ˜¯æ™®é€šæ–‡ä»¶
    if (!std::filesystem::exists(path) || !std::filesystem::is_regular_file(path)) {
        std::cerr << "âŒ æ— æ³•æ‰“å¼€æ–‡ä»¶: " << filePath << std::endl;
        std::string response = "HTTP/1.1 404 Not Found\r\n";
        response += "Content-Type: text/html; charset=UTF-8\r\n";
        response += "Access-Control-Allow-Origin: *\r\n";
        response += "Connection: close\r\n";
        response += "\r\n";
        response += "<!DOCTYPE html><html><body><h1>404 Not Found</h1><p>æ–‡ä»¶ä¸å­˜åœ¨</p></body></html>";
        return response;
    }

    // æ‰“å¼€æ–‡ä»¶
    std::ifstream file(filePath, std::ios::binary | std::ios::ate);
    if (!file.is_open()) {
        std::cerr << "âŒ æ— æ³•æ‰“å¼€æ–‡ä»¶: " << filePath << std::endl;
        std::string response = "HTTP/1.1 404 Not Found\r\n";
        response += "Content-Type: text/html; charset=UTF-8\r\n";
        response += "Access-Control-Allow-Origin: *\r\n";
        response += "Connection: close\r\n";
        response += "\r\n";
        response += "<!DOCTYPE html><html><body><h1>404 Not Found</h1><p>æ–‡ä»¶æ— æ³•è®¿é—®</p></body></html>";
        return response;
    }

    try {
        // è·å–æ–‡ä»¶å¤§å°
        std::streamsize size = file.tellg();
        file.seekg(0, std::ios::beg);

        // è¯»å–æ–‡ä»¶å†…å®¹
        std::vector<char> buffer(size);
        if (!file.read(buffer.data(), size)) {
            std::cerr << "âŒ æ— æ³•è¯»å–æ–‡ä»¶: " << filePath << std::endl;
            std::string response = "HTTP/1.1 500 Internal Server Error\r\n";
            response += "Content-Type: text/html; charset=UTF-8\r\n";
            response += "Access-Control-Allow-Origin: *\r\n";
            response += "Connection: close\r\n";
            response += "\r\n";
            response += "<!DOCTYPE html><html><body><h1>500 Internal Server Error</h1><p>è¯»å–æ–‡ä»¶å¤±è´¥</p></body></html>";
            return response;
        }

        // æ„å»ºå“åº”
        std::string response = "HTTP/1.1 200 OK\r\n";
        response += "Content-Type: " + getMimeType(filePath) + "\r\n";
        response += "Access-Control-Allow-Origin: *\r\n";
        response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
        response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
        response += "Content-Length: " + std::to_string(size) + "\r\n";
        response += "Connection: close\r\n";
        response += "\r\n";

        // è¿½åŠ æ–‡ä»¶å†…å®¹
        response.append(buffer.data(), buffer.size());
        std::cout << "âœ… æˆåŠŸè¿”å›é™æ€æ–‡ä»¶: " << filePath << "ï¼Œå¤§å°: " << size << "å­—èŠ‚" << std::endl;
        return response;
    } catch (const std::bad_alloc& e) {
        std::cerr << "âŒ å†…å­˜åˆ†é…å¤±è´¥: " << e.what() << std::endl;
        std::string response = "HTTP/1.1 500 Internal Server Error\r\n";
        response += "Content-Type: text/html; charset=UTF-8\r\n";
        response += "Access-Control-Allow-Origin: *\r\n";
        response += "Connection: close\r\n";
        response += "\r\n";
        response += "<!DOCTYPE html><html><body><h1>500 Internal Server Error</h1><p>å†…å­˜åˆ†é…å¤±è´¥</p></body></html>";
        return response;
    } catch (const std::exception& e) {
        std::cerr << "âŒ å¤„ç†æ–‡ä»¶æ—¶å‘ç”Ÿå¼‚å¸¸: " << e.what() << std::endl;
        std::string response = "HTTP/1.1 500 Internal Server Error\r\n";
        response += "Content-Type: text/html; charset=UTF-8\r\n";
        response += "Access-Control-Allow-Origin: *\r\n";
        response += "Connection: close\r\n";
        response += "\r\n";
        response += "<!DOCTYPE html><html><body><h1>500 Internal Server Error</h1><p>å¤„ç†æ–‡ä»¶æ—¶å‘ç”Ÿå¼‚å¸¸</p></body></html>";
        return response;
    }
}

// è·å–æ–‡ä»¶çš„MIMEç±»å‹
std::string Server::getMimeType(const std::string& filePath) {
    std::string ext = filePath.substr(filePath.find_last_of(".") + 1);
    for (char& c : ext) {
        c = tolower(c);
    }

    if (ext == "html") return "text/html; charset=UTF-8";
    if (ext == "css") return "text/css; charset=UTF-8";
    if (ext == "js") return "application/javascript; charset=UTF-8";
    if (ext == "json") return "application/json; charset=UTF-8";
    if (ext == "jpg" || ext == "jpeg") return "image/jpeg";
    if (ext == "png") return "image/png";
    if (ext == "gif") return "image/gif";
    if (ext == "svg") return "image/svg+xml";
    if (ext == "ico") return "image/x-icon";
    if (ext == "txt") return "text/plain; charset=UTF-8";
    return "application/octet-stream";
}

// è§£æHTTPè¯·æ±‚
std::map<std::string, std::string> Server::parseHttpRequest(const std::string& request) {
    std::map<std::string, std::string> parsedRequest;
    std::istringstream requestStream(request);
    std::string line;

    // è§£æè¯·æ±‚è¡Œ
    if (std::getline(requestStream, line)) {
        std::istringstream lineStream(line);
        std::string method, path, version;
        lineStream >> method >> path >> version;
        parsedRequest["method"] = method;
        parsedRequest["path"] = path;
        parsedRequest["version"] = version;
    }

    // è§£æè¯·æ±‚å¤´
    while (std::getline(requestStream, line) && line != "\r") {
        if (line.empty()) break;
        size_t colonPos = line.find(":");
        if (colonPos != std::string::npos) {
            std::string key = line.substr(0, colonPos);
            std::string value = line.substr(colonPos + 2, line.size() - colonPos - 3); // å»æ‰å†’å·ã€ç©ºæ ¼å’Œ\r
            parsedRequest[key] = value;
        }
    }

    // è§£æè¯·æ±‚ä½“
    std::string body;
    while (std::getline(requestStream, line)) {
        body += line + "\n";
    }
    if (!body.empty()) {
        parsedRequest["body"] = body.substr(0, body.size() - 1); // å»æ‰æœ€åä¸€ä¸ª\n
        // æ£€æŸ¥æ˜¯å¦æ˜¯multipart/form-dataè¯·æ±‚
        std::string contentType = parsedRequest["Content-Type"];
        if (contentType.find("multipart/form-data") != std::string::npos) {
            parsedRequest["isMultipart"] = "true";
        }
    }

    return parsedRequest;
}

// è¿è¡Œç®€å•çš„HTTPæœåŠ¡å™¨
void Server::runSimpleServer() {
    int server_fd, new_socket;
    struct sockaddr_in address;
    int opt = 1;
    int addrlen = sizeof(address);
    char buffer[30000] = {0};

    // åˆå§‹åŒ–éšæœºæ•°ç§å­
    srand(std::time(nullptr));

    // åˆ›å»ºsocketæ–‡ä»¶æè¿°ç¬¦
    if ((server_fd = socket(AF_INET, SOCK_STREAM, 0)) == 0) {
        std::cerr << "âŒ socketåˆ›å»ºå¤±è´¥" << std::endl;
        return;
    }

    // è®¾ç½®socketé€‰é¡¹
    if (setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR | SO_REUSEPORT, &opt, sizeof(opt))) {
        std::cerr << "âŒ setsockoptå¤±è´¥" << std::endl;
        return;
    }

    // è®¾ç½®åœ°å€
    address.sin_family = AF_INET;
    address.sin_addr.s_addr = INADDR_ANY;
    address.sin_port = htons(pImpl->port);

    // ç»‘å®šsocket
    if (bind(server_fd, (struct sockaddr*)&address, sizeof(address)) < 0) {
        std::cerr << "âŒ ç»‘å®šå¤±è´¥" << std::endl;
        return;
    }

    // ç›‘å¬è¿æ¥
    if (listen(server_fd, 3) < 0) {
        std::cerr << "âŒ ç›‘å¬å¤±è´¥" << std::endl;
        return;
    }

    while (pImpl->running) {
        // æ¥å—è¿æ¥
        if ((new_socket = accept(server_fd, (struct sockaddr*)&address, (socklen_t*)&addrlen)) < 0) {
            if (pImpl->running) {
                std::cerr << "âŒ æ¥å—è¿æ¥å¤±è´¥" << std::endl;
            }
            continue;
        }

        // è¯»å–è¯·æ±‚å¤´
        char headerBuffer[2048] = {0};
        ssize_t headerBytesRead = read(new_socket, headerBuffer, 2048);
        if (headerBytesRead < 0) {
            std::cerr << "âŒ è¯»å–è¯·æ±‚å¤´å¤±è´¥" << std::endl;
            close(new_socket);
            continue;
        }

        std::string requestHeader(headerBuffer, headerBytesRead);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
        bool isFileUpload = (requestHeader.find("POST /api/photos/upload") != std::string::npos);
        
        std::string response;
        
        if (isFileUpload) {
            // ä»URLæŸ¥è¯¢å‚æ•°ä¸­è·å–æ–‡ä»¶å
            std::string filename = "";
            size_t filenamePos = requestHeader.find("filename=");
            if (filenamePos != std::string::npos) {
                size_t endPos = requestHeader.find(" ", filenamePos);
                if (endPos == std::string::npos) {
                    endPos = requestHeader.find("\r", filenamePos);
                }
                if (endPos != std::string::npos) {
                    filename = requestHeader.substr(filenamePos + 9, endPos - filenamePos - 9);
                }
            }
            
            // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼Œä¿ç•™åŸå§‹æ–‡ä»¶æ‰©å±•å
            // ä½¿ç”¨çº³ç§’çº§åˆ«çš„æ—¶é—´æˆ³ï¼Œç¡®ä¿æ–‡ä»¶åå”¯ä¸€
            auto now = std::chrono::high_resolution_clock::now();
            auto now_ns = std::chrono::time_point_cast<std::chrono::nanoseconds>(now);
            auto timestamp_ns = now_ns.time_since_epoch().count();
            std::string uniqueFilename = std::to_string(timestamp_ns);
            if (!filename.empty()) {
                // æå–æ–‡ä»¶æ‰©å±•å
                size_t dotPos = filename.find_last_of(".");
                if (dotPos != std::string::npos) {
                    uniqueFilename += filename.substr(dotPos);
                } else {
                    uniqueFilename += ".jpg"; // é»˜è®¤ä½¿ç”¨jpgæ‰©å±•å
                }
            } else {
                uniqueFilename += ".jpg"; // é»˜è®¤ä½¿ç”¨jpgæ‰©å±•å
            }
            
            // ç”Ÿæˆå®Œæ•´çš„æ–‡ä»¶è·¯å¾„
            std::string imagesDir = getProjectRoot() + "/frontend/images";
            std::string filePath = imagesDir + "/" + uniqueFilename;
            
            // åˆ›å»ºæ–‡ä»¶
            std::ofstream outFile(filePath, std::ios::binary);
            if (outFile.is_open()) {
                // æ‰¾åˆ°è¯·æ±‚ä½“çš„å¼€å§‹ä½ç½®ï¼ˆä¸¤ä¸ªè¿ç»­çš„\r\nä¹‹åï¼‰
                size_t bodyStartPos = requestHeader.find("\r\n\r\n");
                if (bodyStartPos != std::string::npos) {
                    // å†™å…¥è¯·æ±‚å¤´ä¸­åŒ…å«çš„è¯·æ±‚ä½“éƒ¨åˆ†
                    outFile.write(headerBuffer + bodyStartPos + 4, headerBytesRead - bodyStartPos - 4);
                }
                
                // è¯»å–æ‰€æœ‰å‰©ä½™çš„è¯·æ±‚ä½“å¹¶å†™å…¥æ–‡ä»¶ï¼Œç¡®ä¿å®Œæ•´ä¿å­˜å›¾ç‰‡å†…å®¹
                char bodyBuffer[8192] = {0};
                ssize_t bodyBytesRead;
                
                // ä½¿ç”¨é˜»å¡æ¨¡å¼è¯»å–æ•°æ®ï¼Œç¡®ä¿å®Œæ•´è¯»å–æ–‡ä»¶å†…å®¹
                // è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30ç§’
                struct timeval timeout;
                timeout.tv_sec = 30;
                timeout.tv_usec = 0;
                setsockopt(new_socket, SOL_SOCKET, SO_RCVTIMEO, &timeout, sizeof(timeout));
                
                // å¾ªç¯è¯»å–æ‰€æœ‰æ•°æ®ï¼Œç›´åˆ°æ²¡æœ‰æ•°æ®å¯è¯»æˆ–è¶…æ—¶
                while ((bodyBytesRead = read(new_socket, bodyBuffer, sizeof(bodyBuffer))) > 0) {
                    // å†™å…¥æ–‡ä»¶
                    outFile.write(bodyBuffer, bodyBytesRead);
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ­£å¸¸è¯»å–ç»“æŸï¼ˆbodyBytesRead == 0ï¼‰æˆ–è¶…æ—¶/é”™è¯¯
                if (bodyBytesRead < 0) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è¶…æ—¶é”™è¯¯
                    if (errno == EWOULDBLOCK || errno == EAGAIN) {
                        std::cerr << "âš ï¸  è¯»å–æ–‡ä»¶å†…å®¹è¶…æ—¶ï¼Œä½†å·²ä¿å­˜éƒ¨åˆ†å†…å®¹" << std::endl;
                    } else {
                        std::cerr << "âŒ è¯»å–æ–‡ä»¶å†…å®¹å¤±è´¥: " << strerror(errno) << std::endl;
                    }
                }
                
                outFile.close();
                
                // éªŒè¯æ–‡ä»¶å¤§å°
                size_t fileSize = std::filesystem::file_size(filePath);
                
                // ç”ŸæˆæˆåŠŸå“åº”
                std::string photoUrl = "/frontend/images/" + std::filesystem::path(filePath).filename().string();
                response = "HTTP/1.1 200 OK\r\n";
                response += "Content-Type: application/json; charset=UTF-8\r\n";
                response += "Access-Control-Allow-Origin: *\r\n";
                response += "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS\r\n";
                response += "Access-Control-Allow-Headers: Content-Type, Authorization\r\n";
                response += "Connection: keep-alive\r\n";
                response += "\r\n";
                response += "{\"success\": true,\"message\": \"ç…§ç‰‡ä¸Šä¼ æˆåŠŸ\",\"data\": {\"photoId\": " + std::to_string(std::time(nullptr)) + ",\"url\": \"" + photoUrl + "\"}}";
                std::cout << "ğŸ“¸ ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼Œä¿å­˜è·¯å¾„: " << filePath << "ï¼ŒURL: " << photoUrl << "ï¼Œæ–‡ä»¶å¤§å°: " << fileSize << "å­—èŠ‚" << std::endl;
            } else {
                response = "HTTP/1.1 500 Internal Server Error\r\n";
                response += "Content-Type: application/json; charset=UTF-8\r\n";
                response += "Access-Control-Allow-Origin: *\r\n";
                response += "Connection: close\r\n";
                response += "\r\n";
                response += "{\"success\": false,\"message\": \"æ— æ³•åˆ›å»ºæ–‡ä»¶\"}";
                std::cerr << "âŒ æ— æ³•åˆ›å»ºæ–‡ä»¶: " << filePath << std::endl;
            }
        } else {
            // ä¸æ˜¯æ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œä½¿ç”¨æ­£å¸¸çš„è§£ææµç¨‹
            std::string fullRequest(headerBuffer, headerBytesRead);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯POSTè¯·æ±‚ï¼Œå¦‚æœæ˜¯åˆ™è¯»å–å®Œæ•´çš„è¯·æ±‚ä½“
            std::string requestMethod = fullRequest.substr(0, fullRequest.find(" "));
            if (requestMethod == "POST") {
                // è§£æContent-Lengthå¤´ï¼Œè·å–è¯·æ±‚ä½“å¤§å°
                size_t contentLengthPos = fullRequest.find("Content-Length:");
                if (contentLengthPos != std::string::npos) {
                    size_t contentLengthEnd = fullRequest.find("\r\n", contentLengthPos);
                    std::string contentLengthStr = fullRequest.substr(contentLengthPos + 15, contentLengthEnd - contentLengthPos - 15);
                    try {
                        int contentLength = std::stoi(contentLengthStr);
                        
                        // è®¡ç®—å·²ç»è¯»å–çš„è¯·æ±‚ä½“å¤§å°
                        size_t bodyStartPos = fullRequest.find("\r\n\r\n");
                        int readBodySize = 0;
                        if (bodyStartPos != std::string::npos) {
                            readBodySize = headerBytesRead - bodyStartPos - 4;
                        }
                        
                        // å¦‚æœè¿˜æœ‰å‰©ä½™çš„è¯·æ±‚ä½“éœ€è¦è¯»å–
                        if (readBodySize < contentLength) {
                            // è¯»å–å‰©ä½™çš„è¯·æ±‚ä½“
                            int remainingBytes = contentLength - readBodySize;
                            char bodyBuffer[8192] = {0};
                            ssize_t bytesRead;
                            
                            // è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30ç§’
                            struct timeval timeout;
                            timeout.tv_sec = 30;
                            timeout.tv_usec = 0;
                            setsockopt(new_socket, SOL_SOCKET, SO_RCVTIMEO, &timeout, sizeof(timeout));
                            
                            while (remainingBytes > 0 && (bytesRead = read(new_socket, bodyBuffer, sizeof(bodyBuffer))) > 0) {
                                fullRequest.append(bodyBuffer, bytesRead);
                                remainingBytes -= bytesRead;
                            }
                        }
                    } catch (...) {
                        std::cerr << "âŒ è§£æContent-Lengthå¤±è´¥" << std::endl;
                    }
                }
            }
            
            auto parsedRequest = parseHttpRequest(fullRequest);
            
            if (parsedRequest["method"] == "GET") {
                response = handleGetRequest(parsedRequest["path"]);
            } else if (parsedRequest["method"] == "POST") {
                response = handlePostRequest(parsedRequest["path"], parsedRequest["body"]);
            } else if (parsedRequest["method"] == "OPTIONS") {
                response = handleOptionsRequest(parsedRequest["path"]);
            } else {
                response = "HTTP/1.1 405 Method Not Allowed\r\n";
                response += "Allow: GET, POST, OPTIONS\r\n";
                response += "Access-Control-Allow-Origin: *\r\n";
                response += "Connection: close\r\n";
                response += "\r\n";
            }
        }

        // å‘é€å“åº”
        ssize_t bytesSent = send(new_socket, response.c_str(), response.size(), 0);
        if (bytesSent < 0) {
            std::cerr << "âŒ å‘é€å“åº”å¤±è´¥" << std::endl;
        } else {
            std::cout << "âœ… å‘é€å“åº”æˆåŠŸï¼Œå­—èŠ‚æ•°: " << bytesSent << std::endl;
        }

        // å…³é—­è¿æ¥
        close(new_socket);
    }

    // å…³é—­æœåŠ¡å™¨socket
    close(server_fd);
}

// è·å–å½“å‰æ—¶é—´
std::string Server::getCurrentTime() {
    auto now = std::chrono::system_clock::now();
    auto time_t = std::chrono::system_clock::to_time_t(now);
    std::tm* tm = std::localtime(&time_t);
    char buffer[20];
    std::strftime(buffer, sizeof(buffer), "%Y-%m-%d %H:%M:%S", tm);
    return std::string(buffer);
}
